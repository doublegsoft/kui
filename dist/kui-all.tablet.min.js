xhr={request:function(e,t){var i=e.url,n=e.data||e.params||{};let s=e.type||"json",a=e.success,o=e.error;n={...utils.getParameters(e.url),...n},e=e.usecase||"";let r=new XMLHttpRequest;r.timeout=1e4,r.onload=function(){let t=r.responseText;if("json"==s)try{t=JSON.parse(t)}catch(e){return void(o&&o(t))}4==r.readyState&&"200"==r.status?a&&a(t):o&&o(t)},r.onerror=function(){o&&o({error:{code:-500,message:"网络访问错误！"}})},r.ontimeout=function(){o&&o({error:{code:-501,message:"网络请求超时！"}})},r.open(t,i,!0),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("usecase",e),"undefined"!=typeof APPTOKEN&&r.setRequestHeader("apptoken",APPTOKEN),window.user?r.setRequestHeader("_current_user",window.user.userId):r.setRequestHeader("_current_user","unauthorized user"),r.send(JSON.stringify(n))},get:function(e){var t=e.url;e.data;let i=e.success,n=e.error,s=new XMLHttpRequest;s.open("GET",t,!0),s.onload=function(){var e=s.responseText;4==s.readyState&&"200"==s.status?i&&i(e):n&&n(e)},s.send(null)},post:function(e){let t=e.url;"undefined"!=typeof HOST&&-1==t.indexOf("http")&&(t=HOST+t,e.url=t),xhr.request(e,"POST")},put:function(e){xhr.request(e,"PUT")},delete:function(e){xhr.request(e,"DELETE")},connect:function(e){xhr.request(e,"CONNECT")},upload:function(t){var e,i=t.url,n=t.data||t.params;let s=t.type||"json",a=t.success,o=t.error,r=new FormData;for(e in n)r.append(e,n[e]);r.append("file",t.file);let l=new XMLHttpRequest;l.timeout=1e4,l.onload=function(){let t=l.responseText;if("json"==s)try{t=JSON.parse(t)}catch(e){return void(o&&o(t))}4==l.readyState&&"200"==l.status?a&&a(t):o&&o(t)},t.progress&&(l.onprogress=function(e){t.progress(e.loaded,e.total)}),l.onerror=function(){o&&o({error:{code:-500,message:"网络访问错误！"}})},l.ontimeout=function(){o&&o({error:{code:-501,message:"网络请求超时！"}})},l.open("POST",i,!0),"undefined"!=typeof APPTOKEN&&l.setRequestHeader("apptoken",APPTOKEN),l.send(r)},asyncUpload:async function(d){return new Promise(function(e,t){var i=d.url,n=d.data||d.params;let s=d.type||"json";d.success;let a=d.error,o=new FormData;for(var r in n)o.append(r,n[r]);o.append("file",d.file);let l=new XMLHttpRequest;l.timeout=1e4,l.onload=function(){let t=l.responseText;if("json"==s)try{t=JSON.parse(t)}catch(e){return void(a&&a(t))}(4==l.readyState&&"200"==l.status||a)&&e(t)},d.progress&&(l.onprogress=function(e){d.progress(e.loaded,e.total)}),l.onerror=function(){a&&a({error:{code:-500,message:"网络访问错误！"}})},l.ontimeout=function(){a&&a({error:{code:-501,message:"网络请求超时！"}})},l.open("POST",i,!0),"undefined"!=typeof APPTOKEN&&l.setRequestHeader("apptoken",APPTOKEN),l.send(o)})},chain:function(i){if(0!=i.length){var e=i[0];let t=e.success;xhr.promise(e,function(e){t(e),xhr.chain(i.slice(1))})}},asyncGet:function(i,n){return new Promise(function(t,e){i.success=function(e){t(e)},i.error=n,xhr.get(i)})},promise:function(i,n){return new Promise(function(t,e){i.success=function(e){e.error?n?n(e.error):dialog.error(e.error.message):t(e.data)},i.error=n||(()=>{t({error:{code:"500",message:"网络异常"}})}),xhr.post(i)})},longpromise:function(i,n){let e=i.container||dom.find("#container");var t=i.tooltip||"操作处理中...";let s=dom.element(`
    <div class="page-loading hide">
      <div class="ring">${t}
        <span></span>
      </div>
    </div>
  `);return e.appendChild(s),s.classList.remove("hide"),new Promise(function(t,e){i.success=function(e){if(e.error)return setTimeout(()=>{s.classList.add("hide"),s.remove()},600),dialog.error(e.error.message),void(n&&n(e.error));setTimeout(()=>{s.classList.add("hide"),s.remove()},1200),t(e.data)},i.error=n,xhr.post(i)})},download:function(a){let o=new XMLHttpRequest;o.open("POST",a.url,!0),o.responseType="arraybuffer",o.onload=function(){if(200===this.status){let i="",n=o.getResponseHeader("Content-Disposition");if(n&&-1!==n.indexOf("attachment")){let e=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,t=e.exec(n);null!=t&&t[1]&&(i=t[1].replace(/['"]/g,""))}var e,t,s=o.getResponseHeader("Content-Type"),s=new Blob([this.response],{type:s});void 0!==window.navigator.msSaveBlob?window.navigator.msSaveBlob(s,i):(e=window.URL||window.webkitURL,t=e.createObjectURL(s),void 0===(s=document.createElement("a")).download?window.location=t:(s.href=t,s.download=a.filename||"下载的文件",document.body.appendChild(s),s.click()),setTimeout(function(){e.revokeObjectURL(t)},100))}},o.setRequestHeader("Content-type","application/json"),"undefined"!=typeof APPTOKEN&&o.setRequestHeader("apptoken",APPTOKEN),o.send(JSON.stringify(a.params||{}))},asyncRequest:function(e,s){let a=e.url,o=e.data||e.params,r=e.type||"json",l=e.usecase||"";return new Promise((i,n)=>{if(a){let t=new XMLHttpRequest;t.timeout=1e4,t.onload=function(){let e=t.responseText;if("json"==r)try{e=JSON.parse(e)}catch(e){return console.log(e),void n(e)}(4==t.readyState&&"200"==t.status?i:n)(e)},t.onerror=function(){n({error:{code:-500,message:"网络访问错误！"}})},t.ontimeout=function(){n({error:{code:-501,message:"网络请求超时！"}})},t.open(s,a,!0),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("usecase",l),"undefined"!=typeof APPTOKEN&&t.setRequestHeader("apptoken",APPTOKEN),o?t.send(JSON.stringify(o)):t.send(null)}})},asyncPost:function(e){let t=e.url;return"undefined"!=typeof HOST&&-1==t.indexOf("http")&&(t=HOST+t,e.url=t),xhr.asyncRequest(e,"POST")}},"undefined"!=typeof module&&(module.exports={xhr:xhr});var ajax={save:function(e){for(var t=e.url||"",i=e.form,n=e.button,s=e.success,a=i.validate(),o="",r=0;r<a.length;r++)o+=a[r].message+"<br>";""==o?(n&&n.prop("disabled",!0),i=i.formdata(),$.ajax({url:t,data:i,method:"POST",dataType:"json",success:function(e){if(void 0!==e.error)return dialog.error("保存信息出错！"),void(n&&n.prop("disabled",!1));dialog.success("保存信息成功！"),void 0!==s&&s(e),n&&n.prop("disabled",!1)},error:function(){dialog.error("系统异常！"),n&&n.prop("disabled",!1)}})):dialog.error(o)},post:function(t){var e={...utils.getParameters(t.url),...t.data};$.ajax({url:t.url,data:e,method:"POST",dataType:"json",success:function(e){void 0!==t.success&&t.success(e)}})},get:function(t){$.ajax({url:t.url,data:t.data,dataType:"json",success:function(e){void 0!==t.success&&t.success(e)}})},text:function(e,t,i){$.ajax({url:e,data:t,success:function(e){void 0!==i&&i(e)}})},view:function(e){"undefined"!=typeof schedule&&e.clear&&schedule.stop();let t=e.url,n=!1;n=void 0===e.empty||e.empty;let i=e.page;t&&0==t.indexOf(":")&&(i=t.substring(1),t=null);let s=utils.getParameters(e.url),a={...s,...e.params},o=e.title||"",r=e.containerId,l=e.success,d=null;if("string"==typeof r?(d=document.getElementById(r.trim()),null==d&&(d=document.querySelector(r.trim()))):d=r,void 0===a&&(a={}),window.parameters)for(var c in a)window.parameters[c]=a[c];t?xhr.get({url:t,success:function(e){let t=null;d&&(t=utils.append(d,e,n)),t.id&&window[t.id]&&window[t.id].show&&!l&&window[t.id].show(s),l&&l(o,t,s)}}):i&&xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:i},success:function(e){let t=e.data.script;t=t||'<div class="full-width full-height d-flex"><img src="img/under-construction.jpeg" class="m-auto full-width"></div>';let i=null;d&&(i=utils.append(d,t,n)),l&&l(o,i,s)}})}};ajax.append=function(l){"undefined"!=typeof schedule&&l.clear&&schedule.stop();let d=dom.find("#tabsMain"),c=dom.find("#tabsOthers");if(null!=d){let o=d.children.length,i=l.url,s=l.title||"",e=l.containerId,t=l.params,a=l.success,r=null;if("string"==typeof e?(r=document.getElementById(e.trim()),null==r&&(r=document.querySelector(e.trim()))):r=e,void 0===t&&(t={}),window.parameters)for(var u in t)window.parameters[u]=t[u];h();let n=r.querySelector('div[data-url="'+i+'"]');if(null!=n){n.classList.remove("hide"),setTimeout(function(){n.classList.add("show")},150);let e=dom.find('a[data-url="'+i+'"]',d);return null!=e?void e.classList.add("active"):void dom.find('a[data-url="'+i+'"]',c).classList.add("active")}if(0==i.indexOf(":")){let t=i.substring(1);xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:t},success:function(e){e=e.data.script;utils.append(r,e,!1);for(let t=r.children.length-1;0<=t;t--){let e=r.children[t];if("DIV"==e.tagName){e.setAttribute("data-url",i),setTimeout(function(){e.classList.add("show")},150);break}}p(s,i),stdbiz.render(t,r.querySelector('[data-url="'+i+'"]'),{})}})}else m(i);function h(){r.querySelectorAll("div[data-url]").forEach(e=>{e.classList.remove("show"),e.classList.add("hide","fade","fadeIn")}),d.querySelectorAll("a.active").forEach(e=>{e.classList.remove("active")}),c.querySelectorAll("a.active").forEach(e=>{e.classList.remove("active")})}function p(t,i){if(""==t||null==d)return;var e=dom.element(`
      <li class="nav-item">
        <a class="nav-link head-link">
          <span></span>
          <i class="fas fa-times-circle ml-1"></i>
        </a>
      </li>
    `);dom.find("a",e).setAttribute("data-url",i),dom.bind(dom.find("i",e),"click",t=>{t.preventDefault(),t.stopPropagation();let e=t.target.parentElement,i=r.querySelector('div[data-url="'+e.getAttribute("data-url")+'"]');if(i&&i.remove(),t.target.parentElement.parentElement.remove(),0<r.querySelectorAll("div[data-url]").length&&d.children[0].click(),0<c.children.length){let e=c.children[0];e.remove(),t=e,dom.find("a",t).classList.add("nav-link"),dom.find("a",t).classList.remove("dropdown-item"),dom.find("i",t).classList.add("ml-1"),dom.find("i",t).classList.remove("float-right"),d.appendChild(t)}}),dom.bind(dom.find("a",e),"click",e=>{let t=dom.ancestor(e.target,"a");t.classList.contains("active")||(h(),t.classList.add("active"),m(a.getAttribute("data-url")))});let n=!1;if(d.querySelectorAll("li").forEach(e=>{dom.find("span",e).innerText==t&&(n=!0,dom.find("a",e).classList.add("active"))}),n)return;if(0==o)d.appendChild(e);else if(o+1>MAX_HEAD_LINK_COUNT){let e=dom.find("li:last-child",d);e.remove(),i=e,dom.find("a",i).classList.add("pointer"),dom.find("a",i).classList.remove("nav-link"),dom.find("a",i).classList.add("dropdown-item"),dom.find("i",i).classList.remove("ml-1"),dom.find("i",i).classList.add("float-right"),0==c.children.length?c.appendChild(i):c.insertBefore(i,c.children[0])}d.insertBefore(e,d.children[0]);let s=dom.find("span",e),a=dom.find("a",e);a.classList.add("active"),s.innerText=t}function m(n){r.querySelectorAll("div[data-url]").forEach(e=>{e.classList.remove("show"),e.classList.add("hide")});let t=r.querySelector('div[data-url="'+n+'"]');if(null!=t){t.classList.remove("hide"),setTimeout(function(){t.classList.add("show")},150);let e=dom.find('a[data-url="'+n+'"]',d);return null!=e?void e.classList.add("active"):void dom.find('a[data-url="'+n+'"]',c).classList.add("active")}xhr.get({url:n,success:function(e){var t=utils.getParameters(n),i=utils.append(r,e,!1);i.id&&window[i.id]&&window[i.id].show&&window[i.id].show(t);for(let t=r.children.length-1;0<=t;t--){let e=r.children[t];if("DIV"==e.tagName){e.setAttribute("data-url",n),setTimeout(function(){e.classList.add("show")},150);break}}p(s,n),a&&a(s,e)}})}}else ajax.view(l)},ajax.shade=function(t){"undefined"!=typeof schedule&&schedule.stop();let e=t.url,i=t.success,n=document.querySelector(".page.full");null!=n&&n.parentElement.remove(),-1===e.indexOf(":")?xhr.get({url:e,success:function(e){e=utils.append(document.body,e);i&&i(t.title||"",e)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:e.substring(1)},success:function(e){e=e.data.script,e=utils.append(document.body,e);i&&i(t.title||"",e)}})},ajax.shade=function(t){"undefined"!=typeof schedule&&schedule.stop();let e=t.url,i=t.success,n=document.querySelector(".page.full");null!=n&&n.parentElement.remove(),-1===e.indexOf(":")?xhr.get({url:e,success:function(e){e=utils.append(document.body,e);i&&i(t.title||"",e)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:e.substring(1)},success:function(e){e=e.data.script,e=utils.append(document.body,e);i&&i(t.title||"",e)}})},ajax.shade2=function(t){"undefined"!=typeof schedule&&schedule.stop();var e=t.url;let i=t.success;xhr.get({url:e,success:function(e){e=utils.append(document.body,e);i&&i(t.title||"",e)}})},ajax.stack=function(e){"undefined"!=typeof schedule&&e.clear&&schedule.stop();var i=e.pageId,t=e.params;let n=dom.find(e.containerId);let s=!1;for(let t=0;t<n.children.length;t++){let e=n.children[t];"DIV"==e.tagName&&"true"!=e.getAttribute("data-stack-back")&&(e.classList.remove("show"),e.classList.add("hide"),e.id==i&&(e.classList.remove("hide"),e.classList.add("show"),s=!0))}s||(e.empty=!1,ajax.view(e));let a=dom.find("div[data-stack-back]",n);null==a&&(a=dom.element(`
    <div data-stack-back="true" class="pointer">
      <i class="fas fa-angle-left font-32" style="margin-top: 12px;"></i>
    </div>
  `),a.style.position="fixed",a.style.width="60px",a.style.height="60px",a.style.bottom="40px",a.style.right="40px",a.style.backgroundColor="#0C9",a.style.color="#fff",a.style.borderRadius="50px",a.style.textAlign="center",a.style.boxShadow="2px 2px 3px #999",a.style.zIndex="99",dom.bind(a,"click",e=>{a.remove(),ajax.unstack({containerId:n})}),n.appendChild(a))},ajax.unstack=function(e){e=dom.find(e.containerId);let t=e.children[e.children.length-1];t.remove();let i=e.children[e.children.length-1];i.classList.remove("hide"),i.classList.add("show")},ajax.template=function(e){var t=e.url,i=e.usecase;let n=e.containerId,s=e.templateId;var a=e.data;let o=e.success;xhr.post({url:t,usecase:i,data:a,success:function(e){var t;n&&(t=document.getElementById(s).innerHTML,t=Handlebars.compile(t)(e),document.getElementById(n).innerHTML=t),o&&o(e)}})},ajax.dialog=function(e){let t=e.title||"";var i=e.url||"",n=e.params||{};let s=e.success,a=e.end,o=!1!==e.shadeClose,r=!0===e.allowClose,l=e.width||"80%",d=e.height||"",c=e.offset||"auto";if(window.parameters)for(var u in n)window.parameters[u]=n[u];$.ajax({url:i,data:n,async:!0,success:function(e){layer.open({type:1,offset:c,title:t,closeBtn:!0==r?1:0,shade:.5,shadeClose:o,area:[l,d],content:e,success:function(e,t){let i=document.querySelector(".layui-layer-content");i.style+="; overflow: hidden;",s&&s()},end:a||function(){}})}})},ajax.video=function(e,t,i,n){layer.open({type:2,title:!1,closeBtn:1,shade:[0],area:[i+"px",n+"px"],offset:"rb",anim:2,content:[e,"no"]})},ajax.svg=function(e,i,t,n){void 0===t&&(t={}),$.ajax({url:e,data:t,success:function(e){i.empty();var t=(new XMLSerializer).serializeToString(e.documentElement);i.html(t),n&&n(e)}})},ajax.upload=function(t){let e=t.data;void 0===e&&(e={});let i=new FormData;for(var n in e)i.append(n,e[n]);$.ajax({url:t.url,data:i,method:"POST",cache:!1,contentType:!1,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&t.progress&&e.upload.addEventListener("progress",function(e){e.lengthComputable&&t.progress&&t.progress(e.total,e.loaded)},!1),e},success:function(e){t.success&&t.success(e)},error:function(e){t.error&&t.error(e)}})},ajax.sidebar=function(t){let e=dom.find(t.containerId),i=t.success||function(e,t){},n=dom.find("[widget-id=right-bar]"),s=t.allowClose||!1;null!=n&&n.remove(),n=dom.element(`
    <div widget-id="right-bar" style="position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: transparent; z-index: 999999;">
      <div class="right-bar fade show">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="card-header pl-3">
              <h5 class="modal-title"></h5>
              <button type="button" class="close text-danger">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body" style="overflow-y: auto;"></div>
            <div style="position: absolute; bottom: 8px; left: 0; width: 100%; height: 48px; border-top: 1px solid lightgrey; background: white; display:none;">
              <div widget-id="right-bar-bottom" class="mh-10 mt-2" style="float: right;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `),!0===t.showBottom&&(dom.find(".modal-body",n).style.marginBottom="36px",dom.find("[widget-id=right-bar-bottom]",n).parentElement.style.display=""),n.addEventListener("click",e=>{"right-bar"===e.target.getAttribute("widget-id")&&(n.children[0].classList.remove("in"),n.children[0].classList.add("out"),setTimeout(function(){n.remove()},300))}),e.appendChild(n),0==t.url.indexOf(":")&&(t.page=t.url.substring(1),t.url=null),t.url?xhr.get({url:t.url,success:function(e){dom.find(".modal-title",n).innerHTML=t.title||"",dom.find(".modal-body",n).innerHTML="",s||t.close||dom.find("button.close",n).classList.add("hidden"),dom.find("button.close",n).addEventListener("click",function(){n.children[0].classList.add("out"),n.remove(),t.close&&t.close()});e=utils.append(dom.find(".modal-body",n),e);i&&i(t.title||"",e),setTimeout(function(){n.children[0].classList.remove("out"),n.children[0].classList.add("in")},300)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",params:{customWindowId:t.page},success:function(e){e=e.data.script;dom.find(".modal-body",n).innerHTML="";e=utils.append(dom.find(".modal-body",n),e);dom.find(".modal-title",n).innerHTML=t.title||"&nbsp;",s||t.close||dom.find("button.close",n).classList.add("hidden"),dom.find("button.close",n).addEventListener("click",function(){dom.find(".right-bar").classList.add("out"),setTimeout(function(){n.remove()},300),t.close&&t.close()}),i&&i(t.title||"",e),setTimeout(function(){n.children[0].classList.remove("out"),n.children[0].classList.add("in")},300)}})},ajax.bottombar=function(i){let e=dom.find(i.containerId),n=i.success||function(){},s=dom.find(".bottom-bar",e),a=i.allowClose||!1;null!=s&&s.remove(),s=dom.element(`
    <div class="bottom-bar fade show">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="card-header pt-2 pb-2">
            <button type="button" class="close text-danger">
              <i class="fas fa-times"></i>
            </button>
            <h5 class="modal-title"></h5>
          </div>
          <div class="modal-body" style="overflow-y: auto"></div>
        </div>
      </div>
    </div>
  `),e.appendChild(s);var t=s.parentElement.clientWidth,o=parseInt(window.getComputedStyle(s.parentElement,null).getPropertyValue("padding-left")),r=parseInt(window.getComputedStyle(s.parentElement,null).getPropertyValue("padding-right"));s.style.width=t-r-o+"px",i.url?xhr.get({url:i.url,success:function(e){dom.find(".modal-title",s).innerHTML=i.title||"",a||i.close||dom.find("button.close",s).classList.add("hidden"),dom.find("button.close",s).addEventListener("click",function(){dom.find(".bottom-bar").classList.add("out"),i.close&&i.close()}),utils.append(dom.find(".modal-body",s),e),n&&n(e),setTimeout(function(){s.classList.remove("out"),s.classList.add("in")},200)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:i.page},success:function(e){var t=e.data.script;utils.append(dom.find(".modal-body",s),t),dom.find(".modal-title",s).innerHTML=i.title,a||i.close||dom.find("button.close",s).classList.add("hidden"),dom.find("button.close",s).addEventListener("click",function(){dom.find(".bottom-bar").classList.add("out"),i.close&&i.close()}),n&&n(e),setTimeout(function(){s.classList.remove("out"),s.classList.add("in")},200)}})},ajax.tabs=function(e){let t=document.querySelector(e.containerId);var n=e.tabs;e.closeable;let a=dom.create("ul","nav","nav-tabs"),o=dom.create("div","tab-content"),i=dom.create("div","float-right");e=dom.create("button","btn","btn-link");function r(e,t,i,n){ajax.view({url:t,containerId:e,success:function(){window[i]&&window[i].show(n)}})}i.appendChild(e),dom.bind(e,"click",function(){let e=dom.find("li.active link",this.parentElement.parentElement);var t=e.getAttribute("data-model-url"),i=e.getAttribute("data-model-page"),n=JSON.parse("data-model-data");r(dom.find("div.tab-content div[data-model-url='"+t+"']",this.parentElement.parentElement),t,i,n)});for(let i=0;i<n.length;i++){var l=n[i];let e=dom.create("li","nav-item"),s=dom.create("a","nav-link");0==i&&s.classList.add("active"),s.setAttribute("data-model-url",l.url),s.setAttribute("data-model-data",JSON.stringify(l.data||{})),s.setAttribute("data-model-page",l.page),s.innerHTML=l.title,dom.bind(s,"click",function(){if(!this.classList.contains("active")){dom.find("a.active",this.parentElement.parentElement.parentElement).classList.remove("active"),dom.find("div.active",this.parentElement.parentElement.parentElement).classList.remove("active");var t=s.getAttribute("data-model-url"),i=JSON.parse(s.getAttribute("data-model-data")),n=s.getAttribute("data-model-page");let e=dom.find("div.tab-content div[data-model-url='"+t+"']",this.parentElement.parentElement.parentElement);this.classList.add("active"),e.classList.add("active"),""===e.innerHTML.trim()&&r(e,t,n,i)}}),e.appendChild(s),a.appendChild(e);let t=dom.create("div","tab-pane");0==i&&(t.classList.add("active"),r(t,l.url,l.page,l.data)),t.setAttribute("data-model-url",l.url),o.append(t)}t.appendChild(i),t.appendChild(a),t.appendChild(o)},ajax.download=(e,i)=>{fetch(e).then(e=>e.blob()).then(e=>{let t=document.createElement("a");e=window.URL.createObjectURL(e);t.href=e,t.download=i+".docx",t.click(),window.URL.revokeObjectURL(e),t.remove()})},ajax.upload=i=>{let n=dom.create("input");n.setAttribute("type","file"),n.setAttribute("accept",i.accept||"*"),n.style.display="none",n.onchange=async e=>{var t=n.files[0],t=await xhr.asyncUpload({url:"/api/v3/common/upload",params:{directoryKey:i.directoryKey},file:t});i.success&&i.success(t)},n.click()},"undefined"==typeof dialog&&(dialog={}),dialog.alert=function(e){layer.open({type:0,icon:0,offset:"150px",shade:0,shadeClose:!0,title:"警告",content:e})},dialog.info=function(e){layer.open({type:0,offset:"150px",shade:0,shadeClose:!0,title:"信息",content:e})},dialog.info2=function(e){layer.open({type:0,offset:"100px",shade:.3,shadeClose:!0,title:"信息",content:e})},dialog.error=function(e){e=e.replaceAll("\n","<br>"),layer.open({type:0,icon:2,offset:"150px",shade:0,shadeClose:!0,title:"错误",content:e})},dialog.success=function(e,i){i?layer.open({type:0,icon:1,offset:"150px",shade:0,shadeClose:!0,title:"成功",content:e,btn:["确定","确定并返回"],yes:function(e,t){layer.close(e)},btn2:function(e,t){layer.close(e),i()}}):layer.open({type:0,icon:1,offset:"150px",shade:0,shadeClose:!0,title:"成功",content:e})},dialog.confirm=function(e,t){layer.confirm(e,{title:"确认",btn:["确定","取消"]},function(e){layer.close(e),t()},function(){})},dialog.view=function(i){let n=i.title;var e=i.url;$(document.body);$("#dialogApplication").length&&$("#dialogApplication").remove();let s=[];i.save&&s.push({text:"保存",class:"btn-save",onClicked:i.save}),$.ajax({url:e,success:function(e){let t=Handlebars.compile('<div class="modal fade fadeIn show" id="dialogApplication">  <div class="modal-dialog modal-dialog-centered">    <div class="modal-content">      <div class="modal-header">        <h4 class="modal-title">{{title}}</h4>        <button type="button" class="close" data-dismiss="modal">&times;</button>      </div>      <div id="dialogApplicationBody" class="modal-body">{{{body}}}</div>      <div class="modal-footer">        {{#each buttons}}        <button type="button" class="btn {{class}}" data-dismiss="modal">{{text}}</button>        {{/each}}        <button type="button" class="btn btn-close" data-dismiss="modal">关闭</button>      </div>    </div>  </div></div>');e=t({title:n,body:e,buttons:s});$(document.body).append(e),i.success&&i.success({onClosed:i.onClosed}),$("#dialogApplication").modal("show")}})},dialog.select=function(t){ajax.view({url:t.url,success:function(e){layer.open({type:0,icon:1,offset:"150px",shade:.5,shadeClose:!0,title:t.title,content:e})}})},dialog.simplelist=async function(i){var n=await xhr.promise({url:i.url,params:i.params||{}}),e=dom.element(`
    <div>
      <ul class="list-group"></ul>
    </div>
  `);let s=dom.find("ul",e);for(let t=0;t<n.length;t++){var a=n[t];let e=dom.create("li","list-group-item","list-group-item-action");dom.model(e,a),e.innerText=a[i.fields.text],s.appendChild(e)}layer.open({type:0,closeBtn:1,btn:[],shade:.5,shadeClose:!0,title:"",content:e.innerHTML,success:function(e,t){e.get(0).querySelectorAll("li").forEach((e,t)=>{dom.bind(e,"click",e=>{layer.close(layer.index);e=dom.model(e.target);i.onAccept(e)})})}})},dialog.html=function(i){layer.open({type:0,closeBtn:1,offset:"150px",shade:.5,area:["50%",""],shadeClose:!0,title:i.title||"&nbsp;",content:i.html,btn:["确定","关闭"],success:function(e,t){i.load&&i.load(e,t)},yes:function(e){layer.close(e),i.success()},btn1:function(){}})},dialog.iframe=function(e){layer.open({title:e.title,type:2,area:[e.width,e.height],content:e.url,resize:!1,maxmin:!0,shade:!1,success:e.success||function(e,t){}})};var dom={value:function(e,t){const i=document.querySelector(e);if(!t)return i.value.trim();i.value=t},empty:function(e){const t=document.querySelector(e);t.value?t.value="":t.innerHTML=""},valid:function(e){const t=document.querySelector(e);return void 0!==t.value&&null!=t.value&&""!=t.value.trim()},create:function(e){var t=Array.prototype.slice.call(arguments,1);let i=document.createElement(e);for(let e=0;e<t.length;e++)i.classList.add(t[e]);return i},fix:function(e){let t=null;t="string"==typeof e?document.querySelector(e):e;var i=t.getBoundingClientRect(),n=i.left,s=i.top,a=(i.width,i.height),o=(parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-left")),parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-right")),parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-top"))),r=parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-bottom"));parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-left")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-right")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-top")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-bottom"));let l=t.parentElement.parentElement;e=l.getBoundingClientRect(),i=parseInt(window.getComputedStyle(l,null).getPropertyValue("padding-left"));parseInt(window.getComputedStyle(l,null).getPropertyValue("padding-right")),parseInt(window.getComputedStyle(l,null).getPropertyValue("padding-top")),parseInt(window.getComputedStyle(l,null).getPropertyValue("padding-bottom"));return t.style.position="absolute",t.style.top=s-e.top+"px",t.style.left=n-e.left+"px",t.style.width="calc(100% - "+2*i+"px )",{top:s-e.top,left:n-e.left,width:e.width-2*i,height:a+o+r}},find:function(e,t){if(t=t||document,"string"!=typeof e)return e;e=t.querySelectorAll(e);return 0==e.length?null:1==e.length?e[0]:e},ancestor:function(e,t,i){let n=null;if(i=i||"",n="string"==typeof e?document.querySelector(e):e,null==n)return null;t=t.toUpperCase();let s=n;if(""==i)for(;null!=s&&s.tagName!=t;)s=s.parentElement;else for(;null!=s&&(s.tagName!=t||!s.classList.contains(i));)s=s.parentElement;return s},element:function(e){let t=document.createElement("div");return t.innerHTML=e,t.firstElementChild},bind:function(e,t,i){let n=null;n="string"==typeof e?document.querySelector(e):e,null!=n&&n&&n.addEventListener(t,i)},model:function(e,i){let n=null;if(n="string"==typeof e?document.querySelector(e):e,void 0===i){let i={};return Array.prototype.slice.call(n.attributes).forEach(function(t){if(0==t.name.indexOf("data-model-"))if(0==t.value.indexOf("{"))try{i[utils.nameVar(t.name.slice("data-model-".length))]=JSON.parse(t.value)}catch(e){i[utils.nameVar(t.name.slice("data-model-".length))]=t.value}else i[utils.nameVar(t.name.slice("data-model-".length))]=t.value}),i}var s=Array.prototype.slice.call(arguments,2);if(0==s.length)for(const t in i)0!=t.indexOf("||")&&0!=t.indexOf("//")&&0!=t.indexOf(">>")&&("object"==typeof i[t]?n.setAttribute(utils.nameAttr(t),JSON.stringify(i[t])):n.setAttribute(utils.nameAttr(t),i[t]));else for(let t=0;t<s.length;t++){let e=s[t];0!=e.indexOf("||")&&0!=e.indexOf("//")&&0!=e.indexOf(">>")&&("object"==typeof i[e]?n.setAttribute(utils.nameAttr(e),JSON.stringify(i[e])):n.setAttribute(utils.nameAttr(e),i[e]))}},collect:function(e,n){let s=[],a=document.querySelectorAll(e);for(let i=0;i<a.length;i++){let t={};if(Array.isArray(n))for(let e=0;e<n.length;e++)t[n[e]]=a[i].getAttribute(utils.nameAttr(n[e]));else t[n]=a.getAttribute(utils.nameAttr(n[j]));s.push(t)}return s},propagate:function(e,t,i,n){let s=n(t);if(Array.isArray(i))for(let e=0;e<i.length;e++)s.setAttribute(utils.nameAttr(i[e]),t[i[e]]);else s.setAttribute(utils.nameAttr(i),t[i]);e.appendChild(s)},toggle:function(e,a){var i=document.querySelectorAll(e);for(let t=0;t<i.length;t++){let e=i[t];e.addEventListener("click",function(){let e=this.getAttribute("data-toggle"),t=e.split(">>"),i=t[0].split("+"),n=t[1].split("+"),s=!1;for(let t=0;t<i.length;t++){let e=i[t].trim();s=0==e.indexOf(".")?this.classList.contains(e.substring(1)):null!=this.querySelector(e)}if(s){for(let e=0;e<n.length;e++){let t=n[e].trim();if(0===t.indexOf("."))this.classList.add(t.substring(1));else{let e=this.querySelector(t.substring(0,t.indexOf(".")));e.classList.add(t.substring(t.indexOf(".")+1))}}for(let e=0;e<i.length;e++){let t=i[e].trim();if(0==t.indexOf("."))this.classList.remove(t.substring(1));else{let e=this.querySelector(t);e.classList.remove(t.substring(t.indexOf(".")+1))}}}else{for(let e=0;e<i.length;e++){let t=i[e].trim();if(0==t.indexOf("."))this.classList.add(t.substring(1));else{let e=this.querySelector(t.substring(0,t.indexOf(".")));e.classList.add(t.substring(t.indexOf(".")+1))}}for(let e=0;e<n.length;e++){let t=n[e].trim();if(0==t.indexOf("."))this.classList.remove(t.substring(1));else{let e=this.querySelector(t);e.classList.remove(t.substring(t.indexOf(".")+1))}}a&&resovle(this)}})}},switch:function(e,n){let s=dom.find(e),t=s.getAttribute("data-switch"),a=t.split("+");var o=s.querySelectorAll(a[0]);for(let e=0;e<o.length;e++){let i=o[e];i.onclick=e=>{let t=s.querySelectorAll(a[0]);for(let e=0;e<t.length;e++)t[e].classList.remove(a[1].substring(1));i.classList.add(a[1].substring(1)),n&&n(i)}}},tabs:function(e){let n=dom.find(e);if(null!=n){let i=n.getAttribute("data-tab-active-class");for(let e=0;e<n.children.length;e++){let t=n.children[e];t.addEventListener("click",e=>{for(let t=0;t<n.children.length;t++){let e=n.children[t];e.classList.remove(i)}t.classList.add(i)})}}},top:function(e){let t=null;if(t="string"==typeof e?document.querySelector(e):e,null==t)return 0;let i=t.offsetTop;return void 0!==t.offsetParent&&(i+=dom.top(t.offsetParent)),i},formdata:function(e,t){let s=null;if(s="string"==typeof e?document.querySelector(e):e,void 0===t){let i={},n={};var a=s.querySelectorAll("input");for(let t=0;t<a.length;t++){var o=a[t];let e=o.name;var r=o.type,l=o.value;"text"==r||"number"==r||"password"==r||"hidden"==r?(i[e]=null,""!=l?-1!=e.indexOf("[]")?i[e]=[l]:i[e]=l:i[e]=""):"radio"==r?o.checked&&(i[e]=l):"checkbox"==r&&(void 0===n[e]&&(n[e]=0),o.checked&&(void 0===i[e]&&(n[e]=0,i[e]=[]),i[e].push(l)),n[e]+=1)}var d=s.querySelectorAll("select");for(let t=0;t<d.length;t++){var c=d[t];let e=c.name;i[e]=null,-1!=c.selectedIndex?-1!=e.indexOf("[]")?i[e]=[c.value]:i[e]=c.value:i[e]=""}var u,h,p=s.querySelectorAll("textarea");for(let e=0;e<p.length;e++){var m=p[e],f=m.name;i[f]=null,i[f]=m.value}for(u in n)-1==u.indexOf("[]")&&1==n[u]&&i[u]&&(i[u]=i[u][0]);for(h in i)"string"==typeof i[h]&&0==i[h].indexOf("${")&&(i[h]=i[i[h].substring(2,i[h].length-1)]);return i}function i(e,t,i){let n=dom.find("[name='"+t+"']",e);if(null!=n){if(1<n.length&&"radio"==n[0].type){let e=n;e.forEach((e,t)=>{e.value===i?e.checked=!0:e.checked=!1})}"INPUT"==n.tagName?"check"==n.type||(n.value=i||""):"SELECT"==n.tagName?$("select[name='"+t+"']").val(i).trigger("change"):"TEXTAREA"==n.tagName&&(n.innerHTML=i)}}for(var n in t)if("object"==typeof t[n])for(var g in t[n])i(s,n+"."+g,t[n][g]);else i(s,n,t[n])},setAttribute:function(e,t,i){let n=document.querySelectorAll(e);for(let e=0;e<n.length;e++)n[e][t]=i},removeAttribute:function(e,t){let i=document.querySelectorAll(e);for(let e=0;e<i.length;e++)i[e].removeAttribute(t)},enable:function(e){let t=document.querySelectorAll(e);for(let e=0;e<t.length;e++)t[e].disabled=!1},disable:function(e){let t;t="string"==typeof e?document.querySelectorAll(e):e;for(let e=0;e<t.length;e++)t[e].disabled=!0},index:function(e,i,t){let n;if(n="string"==typeof e?dom.find(e):e,!t){var s=n.getAttribute(i),a=n.parentElement.querySelectorAll(n.tagName);for(let t=0;t<a.length;t++){let e=a[t];if(s==e.getAttribute(i))return t}}return-1},elementAt:function(e,i,n){var s=document.querySelectorAll(e);for(let t=0;t<s.length;t++){let e=s[t];if(n==e.getAttribute(i))return{index:t,element:e}}return null},elementAtTree:function(e,i,n,s,a){var o=document.querySelectorAll(e);let r=0;for(let t=0;t<o.length;t++){let e=o[t];var l=e.getAttribute(i),d=e.getAttribute(n);if(a==d&&(r++,s==l))return{index:r,element:e}}},stack:function(t,i,n,s){let a=dom.create("a","btn","btn-link");var e=dom.create("i","fas","fa-caret-right","mr-1");a.appendChild(e),dom.bind(a,"click",function(){let e=dom.find("i",a);e.classList.contains("fa-caret-right")?(t.container.querySelectorAll("i.fa-caret-down").forEach(e=>{e.classList.remove("fa-caret-down"),e.classList.add("fa-caret-right")}),e.classList.remove("fa-caret-right"),e.classList.add("fa-caret-down"),t.stack(n,function(e){e.parentElement.classList.add("fade","fadeIn"),e.style.paddingLeft="50px",e.style.paddingRight="50px",setTimeout(function(){e.parentElement.classList.add("show")},200),s(e)})):(e.classList.remove("fa-caret-down"),e.classList.add("fa-caret-right"),i.parentElement.nextSibling.remove())})},inner:function(e){var t=e.clientHeight,i=e.clientWidth,e=getComputedStyle(e);return{height:t-parseInt(e.paddingTop)-parseInt(e.paddingBottom),width:i-parseInt(e.paddingLeft)-parseInt(e.paddingLeft)}},outer:function(e){var t=e.clientHeight,i=e.clientWidth,e=getComputedStyle(e);return{height:t+parseInt(e.marginTop)+parseInt(e.borderTop)+parseInt(e.marginBottom)+parseInt(e.borderBottom),width:i+parseInt(e.marginLeft)+parseInt(e.borderLeft)+parseInt(e.marginRight)+parseInt(e.borderRight)}},height:function(e,t,i){t=t||0,i=(i=void 0===i?dom.find("#container"):i)||document.body;let n=null;n="string"==typeof e?document.querySelector(e):e;var s=dom.top(n);let a=getComputedStyle(i,null);parseInt(a.getPropertyValue("padding-top"));e=parseInt(a.getPropertyValue("padding-bottom"));a=getComputedStyle(n,null);parseInt(a.getPropertyValue("border-top-width")),parseInt(a.getPropertyValue("border-bottom-width"));n.style.marginBottom="0px",n.style.height=i.clientHeight-s-t-e+"px",n.style.overflowY="auto"},height2:function(e,t,i){t=t||0,i=(i=void 0===i?dom.find("#container"):i)||document.body;let n=null;n="string"==typeof e?document.querySelector(e):e;dom.top(n);let s=getComputedStyle(i,null);var a=parseInt(s.getPropertyValue("padding-top")),o=parseInt(s.getPropertyValue("padding-bottom"));s=getComputedStyle(n,null);var r=parseInt(s.getPropertyValue("border-top-width")),l=parseInt(s.getPropertyValue("border-bottom-width")),d=parseInt(s.getPropertyValue("border-top-width")),e=parseInt(s.getPropertyValue("border-bottom-width"));n.style.marginBottom="0px";i=i.getBoundingClientRect();n.style.height=i.height-a-o-r-l-d-e-t+"px",n.style.overflowY="auto"},templatize:function(e,t){let i=Handlebars.compile(e);t=i(t);return dom.element(t)}};dom.render=function(e,t,s){let i=null;function n(e,t,i){let n=dom.find("[name='"+t+"']",e);null!=n&&("DIV"===n.nodeName&&s?i&&function(e,t){let i=dom.find("[value='"+t+"']",e);null!=i&&(i.checked=!0)}(n,i):"INPUT"==n.tagName?"radio"==n.type||(n.value=i):"SPAN"==n.tagName?i&&(n.innerHTML=i):"SELECT"==n.tagName&&$("select[name='"+t+"']").val(i).trigger("change"))}for(var a in i="string"==typeof e?document.querySelector(e):e,t)if("object"==typeof t[a])for(var o in t[a])n(i,a+"."+o,t[a][o]);else n(i,a,t[a])},dom.popup=function(e,t){let i=dom.create("div","full-width","full-height","position-absolute");return i.style.background="transparent",dom.bind(i,"click",e=>{i.remove(),t.remove()}),document.body.appendChild(i),e.appendChild(t),i},dom.html=function(e){let t=dom.element("<div></div>");return t.appendChild(e),t.innerHTML},dom.init=function(t,i){if(i){let e=i.getAttribute("name");e&&""!=e||(e=i.getAttribute("widget-id")),e&&""!=e&&(t[e]=i);for(let e=0;e<i.children.length;e++){var n=i.children[e];dom.init(t,n)}}};var NO_ERRORS=0,REQUIRED_ERROR=1,FORMAT_ERROR=2,INVALID_ERROR=3;function DataSheet(e){this.columns=e.columns,this.columnCount=this.getColumnCount(this.columns),this.rowHeaderWidth=e.rowHeaderWidth||150,this.rowHeaders=e.rowHeaders,this.rowCount=this.getRowCount(this.rowHeaders),this.readonly=!0===e.readonly,this.totalColumns=[];for(let e=0;e<this.columns.length;e++){var t=this.columns[e];t.totalable&&this.totalColumns.push(t)}this.onCellClicked=e.onCellClicked,this.onRowHeaderClicked=e.onRowHeaderClicked,this.rowHeaderColumnCount=this.getRowHeaderColumnCount(this.rowHeaders),this.colHeaderColumnCount=this.getColumnHeaderColumnCount(this.columns),this.rowHeaderRowCount=this.getRowHeaderRowCount(this.rowHeaders),this.colHeaderRowCount=this.getColumnHeaderRowCount(this.columns),this.matrixColumn=[],this.matrixRowHeader=[],this.buildColumnMatrix(this.columns,this.matrixColumn,0),this.buildRowHeaderMatrix(this.rowHeaders,this.matrixRowHeader,0)}function Tabs(e){this.navigator=dom.find(e.navigatorId),this.content=dom.find(e.contentId),this.tabActiveClass=e.tabActiveClass,this.tabs=e.tabs,this.lazy=!1!==e.lazy,this.autoClear=!0===e.autoClear}function PaginationGrid(e){let t=this;"object"==typeof e.url?(this.url=e.url.root,this.urlChild=e.url.child):this.url=e.url,"object"==typeof e.usecase?(this.usecase=e.usecase.root,this.usecaseChild=e.usecase.child):this.usecase=e.usecase,this.onRender=e.render,this.filters=e.params||e.filters||{},this.favourite=e.favourite||!1,this.start=e.start||0,this.limit=e.limit||5,this.colspan=e.colspan,this.borderless=e.borderless||!1,e.filter&&(e.filter.query={callback:function(e){t.go(1,e)}},(e.filter.table=this).queryFilter=new QueryFilter(e.filter))}function Timeline(e){this.url=e.url,this.params=e.params||{},this.data=e.data||[],this.fnTitle=e.title||function(e,t){return""},this.fnSubtitle=e.subtitle||function(e,t){return""},this.fnContent=e.content||function(e,t){return""},this.onComplete=e.onComplete}function ListView(e){this.url=e.url,this.usecase=e.usecase,this.params=e.params||{},this.lazy=!0===e.lazy,this.hoverable=!1!==e.hoverable,this.activateable=!0===e.activateable,this.itemClass=e.itemClass||[],this.slidingActions=e.slidingActions||[],this.emptyHtml=e.emptyHtml,this.idField=e.idField,this.compare=e.compare||function(e,t){return!1},this.selections=e.selections||[],this.local=e.local||[],this.create=e.create||function(e,t){},this.complete=e.complete,this.draggable=!0===e.draggable,this.start=e.start||0,this.limit=e.limit||-1,this.borderless=e.borderless||!1,this.height=e.height,this.tooltip=e.tooltip,this.required=e.required||!1,this.onRemove=e.onRemove,this.onReorder=e.onReorder,this.onCheck=e.onCheck,this.onSelect=e.onSelect,this.onFilter=e.onFilter,this.onAdd=e.onAdd,this.onSearch=e.onSearch,this.onClick=e.onClick,this.observableItems=new rxjs.Observable}function Wizard(e){this.topic=e.topic,this.steps=e.steps||[],this.root=dom.element(`
    <div>
      <div class="ui ordered steps m-b-0">
      </div>
      <div class="tab-content">
      </div>
    </div>
  `)}function Chat(e){this.host=e.host||"",this.userId=e.userId,this.userType=e.userType,this.getConversations=e.getConversations,this.onInit=e.onInit||async function(){},this.onSendTextMessage=e.onSendTextMessage,this.onSendImageMessage=e.onSendImageMessage,this.onSendAudioMessage=e.onSendAudioMessage,this.onSendVideoMessage=e.onSendVideoMessage,this.onSendCustomMessage=e.onSendCustomMessage,this.onRevokeMessage=e.onRevokeMessage||function(e){},this.onMessageReceived=e.onMessageReceived,this.onUnreadMessages=e.onUnreadMessages||function(e){},this.onReadMessages=e.onReadMessages||function(e){}}String.prototype.trim||function(){var e=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(e,"")}}(),$.fn.validate=function(e){return Validation.validate(this,e)},Validation={validate:function(e,t){var o=[];void 0===e&&(e=$(document)),(e=$(e)).find("input[type!=checkbox][type!=radio][type!=button]").each(function(e,t){var i=$(t).val().trim(),n=Validation.getLabel(t),s=$(t).attr("data-required-message")?$(t).attr("data-required-message"):n+"必须填写！";Validation.isRequired(t)&&""===i&&o.push({element:t,message:s});var a=$(t).attr("data-domain-type");if(a){s=n+"填写不合要求。",a=Validation.getDomainValidator(new ValidationModel(a));if(null!=a&&""!==i){i=a.test(i);switch(i){case REQUIRED_ERROR:break;case FORMAT_ERROR:s=$(t).attr("data-format-message")?$(t).attr("data-format-message"):s;break;case INVALID_ERROR:s=$(t).attr("data-invalid-message")?$(t).attr("data-invalid-message"):s}i!=NO_ERRORS&&o.push({element:$(t),message:s})}}}),e.find("textarea").each(function(e,t){var i=$(t).val().trim(),n=Validation.getLabel(t),s=$(t).attr("data-required-message")?$(t).attr("data-required-message"):n+"必须填写！";Validation.isRequired(t)&&""===i&&o.push({element:t,message:s});var a=$(t).attr("data-domain-type");if(a){s=n+"填写不合要求。",a=Validation.getDomainValidator(new ValidationModel(a));if(null!=a&&""!==i){i=a.test(i);switch(i){case REQUIRED_ERROR:break;case FORMAT_ERROR:s=$(t).attr("data-format-message")?$(t).attr("data-format-message"):s;break;case INVALID_ERROR:s=$(t).attr("data-invalid-message")?$(t).attr("data-invalid-message"):s}i!=NO_ERRORS&&o.push({element:$(t),message:s})}}}),e.find("select").each(function(e,t){var i;!Validation.isRequired(t)||"-1"!=$(t).val()&&""!=$(t).val()&&null!=$(t).val()||(i=Validation.getLabel(t)+"必须选择！",i=$(t).attr("data-required-message")?$(t).attr("data-required-message"):i,o.push({element:$(t),message:i}))});var i={};for(r in e.find("input[type=checkbox]").each(function(e,t){t=$(t).attr("name");i[t]=t}),i){var n=!1,s=null,a=null;e.find('input[name="'+r+'"]').each(function(e,t){0==e&&(s=Validation.getLabel(t),a=t),!n&&$(t).prop("checked")&&(n=!0)}),!n&&Validation.isRequired(a)&&(l=s+"必须选择！",l=$(a).attr("data-required-message")?$(a).attr("data-required-message"):l,o.push({element:$(a),message:l}))}var r,i={};for(r in e.find("input[type=radio]").each(function(e,t){t=$(t).attr("name");i[t]=t}),i){var l,n=!1,s=null,a=null;e.find('input[name="'+r+'"]').each(function(e,t){0==e&&(s=Validation.getLabel(t),a=t),!n&&$(t).prop("checked")&&(n=!0)}),!n&&$(a).prop("required")&&(l=s+"必须选择！",l=$(a).attr("data-required-message")?$(a).attr("data-required-message"):l,o.push({element:$(a),message:l}))}return e.find("input[remote]").each(function(e,t){var i=$(t).attr("remote"),n=$(t).val().trim();i&&""!=i&&""!=n&&$.ajax({url:i,method:"POST",data:"check="+n,success:function(e){e=$.parseJSON(e);e.err&&o.push({element:$(t),message:e.msg})}})}),t&&t(o),o},getLabel:function(e){e=$(e);return e.attr("label")||$(e).attr("data-required")||e.attr("name")||e.attr("id")},isRequired:function(e){let t=$(e);return!!t.prop("required")||("required"==t.attr("required")||void 0!==t.attr("data-required")&&""!=t.attr("data-required"))},getDomainValidator:function(e){var t=e.keyword.toLowerCase(),i=e,e=null;if("mail"===t||"email"===t)e=new Validation.Mail;else if("number"===t)e=new Validation.Number(i.symbol,i.args);else if("string"===t)e=new Validation.String(i.args);else if("mobile"===t)e=new Validation.Mobile;else if("range"===t)e=new Validation.Range(i.opts,i.args);else if("phone"===t)e=new Validation.Phone;else if("cmpexp"===t)e=new Validation.CmpExp(i.args[0],i.args[1]);else if("regexp"===t)e=new Validation.RegExp(i.args[0]);else if("remote"===t)e=new Validation.Remote(i.args[0]);else if("date"===t)e=new Validation.Date;else if("time"===t)e=new Validation.Time;else{if("datetime"!==t)throw new Error('not support for the domain("'+t+'")');e=new Validation.DateTime}return e},String:function(e){this.min=0,this.max=parseInt(e[0]),1<e.length&&(this.min=parseInt(e[0]),this.max=parseInt(e[1])),this.test=function(e){return e.length<this.min||this.max&&e.length>this.max?FORMAT_ERROR:NO_ERRORS}},Number:function(e,t){this.plus=-1,this.minus=-1,"-"===e?this.minus=0:"+"===e&&(this.plus=0),0!=this.minus&&this.plus,this.precision=parseInt(t[0]),1<t.length&&(this.scale=parseInt(t[1])),this.test=function(e){if(0==this.plus){if(!/^\s*(\+)?((\d+(\.\d+)?)|(\.\d+))\s*$/.test(e))return FORMAT_ERROR}else if(0==this.minus){if(!/^\s*(-)((\d+(\.\d+)?)|(\.\d+))\s*$/.test(e))return FORMAT_ERROR}else if(!/^\s*(\+)?((\d+(\.\d+)?)|(\.\d+))\s*$/.test(e))return FORMAT_ERROR;var t=e.indexOf("."),i=-1==t?this.precision:this.precision+1,i=0==this.plus||0==this.minus?i+1:i;if(e.length>i)return FORMAT_ERROR;if(-1!=t&&this.scale&&e.substring(t+1).length>this.scale)return FORMAT_ERROR;return NO_ERRORS}},Mail:function(){this.test=function(e){return/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(e)?NO_ERRORS:FORMAT_ERROR}},Phone:function(){this.test=function(e){return/^\d{11}$/i.test(e)?NO_ERRORS:FORMAT_ERROR}},Mobile:function(){this.test=function(e){return/^\d{11}$/i.test(e)?NO_ERRORS:FORMAT_ERROR}},Date:function(){this.test=function(e){return/^\d{4}-\d{1,2}-\d{1,2}$/.test(e)?isNaN(Date.parse(e))?INVALID_ERROR:NO_ERRORS:FORMAT_ERROR}},Time:function(){this.test=function(e){return/^\d{1,2}:\d{1,2}(:\d{1,2})?$/.test(e)?(e="1970-01-01 "+e,isNaN(Date.parse(e))?INVALID_ERROR:NO_ERRORS):FORMAT_ERROR}},DateTime:function(){this.test=function(e){return/^\d{4}-\d{1,2}-\d{1,2} \d{1,2}:\d{1,2}(:\d{1,2})?$/.test(e)?isNaN(Date.parse(e))?INVALID_ERROR:NO_ERRORS:FORMAT_ERROR}},RegExp:function(e){this.re=new RegExp(e),this.test=function(e){return this.re.test(e)?NO_ERRORS:FORMAT_ERROR}},CmpExp:function(type,expr){this.model=new ValidationModel(type),this.expr=expr,this.ignore=!1;var self=this;this.test=function(str){var expr=this.expr,dt=Validation.getDomainValidator(this.model);if(dt.test(str)!=NO_ERRORS)return FORMAT_ERROR;if($("input[type!=checkbox][type!=radio][type!=button]").each(function(e,t){var i=$(t).attr("name"),t=$(t).val();-1!=expr.indexOf(i)&&(""==t&&(self.ignore=!0),expr=expr.replace(new RegExp(i,"g"),t))}),!this.ignore)try{if(!eval(expr))return INVALID_ERROR}catch(e){return INVALID_ERROR}return NO_ERRORS}},Remote:function(t){this.test=function(e){$.ajax({url:t+e,dataType:"json",success:function(e){e.error}})}},Range:function(i,e){this.min=parseFloat(e[0]),this.max=parseFloat(e[1]),this.test=function(e){var t=parseFloat(e.trim());if(isNaN(t))return INVALID_ERROR;e=!1;return">"==i[0]?e=t>this.min:">="===i[0]&&(e=t>=this.min),e?("<"==i[1]?e=t<this.max:"<="===i[1]&&(e=t<=this.max),e?NO_ERRORS:INVALID_ERROR):INVALID_ERROR}}},ValidationModel=function(e){this.symbol="",this.keyword="",this.opts=[],this.args=[],this.unary_ops={"+":!0,"-":!0},this.keywords={string:!0,number:!0,range:!0,regexp:!0,mobile:!0,email:!0,phone:!0,cmpexp:!0};for(var t=0,i=e.length,n="";t<i;){var s=e.charAt(t);if(this.isUnaryOp(s)&&0==t)this.symbol=s;else if("["==s)if(""!=this.keyword)n+=s;else{if(!this.stringEqual("range",n))throw new Error('"[" is just available for range.');this.keyword=n,this.opts.push(">="),n=""}else"("==s?""!=this.keyword?(this.opts.push("("),n+=s):(this.keyword=n,this.opts.push(">"),n=""):"]"==s?(this.opts.push("<="),this.args.push(n),n=""):")"==s&&t==i-1?(this.args.push(n),this.opts.push("<"),n=""):")"==s?(this.opts.pop("<"),1==this.opts.length&&(n+=s)):","==s&&1==this.opts.length?(this.args.push(n),n=""):n+=s;t++}""==this.keyword&&(this.keyword=n)},ValidationModel.prototype={isKeyword:function(e){return this.keywords[e.toLowerCase()]},isUnaryOp:function(e){return this.unary_ops[e]},isDecimalDigit:function(e){return 48<=e&&e<=57},isIdentifierStart:function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122},isIdentifierPart:function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57},stringEqual:function(e,t){return e.toLowerCase()===t.toLowerCase()}},$.fn.formdata=function(t){if(void 0!==t){let e;e="string"==typeof t?$.parseJSON(t):t,$(this).find("input").each(function(e,t){$(this).val("")}),$(this).find("input[type=checkbox]").each(function(e,t){$(this).prop("checked",!1)}),$(this).find("textarea").each(function(e,t){$(this).val("")});let a=e;for(let s in a){let n;this.find("[name="+s+"]").each(function(e,t){if(n=$(this)[0].nodeName,"INPUT"!=n||"radio"!=$(this).attr("type")&&"checkbox"!=$(this).attr("type"))if("INPUT"!=n||"file"!=$(this).attr("type")&&"button"!=$(this).attr("type"))if("SELECT"==n){let t=!1;$(this).find("option").each(function(){let e=$(this);e.attr("value")==a[s]&&(e.prop("selected",!0),t=!0)}),t||$(this).val($($(this).find("option:first")).val()),$(this).val(null).trigger("change")}else"date"==$(this).attr("data-domain-type")?$(this).val(moment(a[s]).format("YYYY-MM-DD")):$(this).val(a[s]);else;else if(a[s].constructor==Array){var i=a[s];for(let e=0;e<i.length;e++)$(this).val()==i[e]&&$(this).prop("checked",!0)}else $(this).val()==a[s]&&$(this).prop("checked",!0)})}return{}}let r={};return this.find("input[type!=checkbox][type!=radio][type!=button]").each(function(e,n){let s=$(n).attr("name");if(s){let t=s,i="";var a=-1!=s.indexOf("[]"),o=s.indexOf("."),n=$(n).val();if(-1!=o&&(t=s.substr(0,o),i=s.substr(o+1,a?s.indexOf("[]")-t.length-1:s.length-t.length-1)),a)if(r[t]=r[t]||[],""!=i){let e={};e[i]=n,r[t].push(e)}else r[s].push(n);else if(""!=i){let e={};e[i]=n,r[t]=s}else r[s]=n}}),this.find("input[type=checkbox]").each(function(e,n){if($(n).prop("checked")){let i=$(n).attr("name");if(-1!=i.indexOf("[]")){let t=i;var s=t.indexOf(".");if(-1==s)r[t]=r[t]||[],r[t].push($(n).val());else{t=i.substr(0,s),s=i.substr(s+1,i.indexOf("[]")-t.length-1),r[t]=r[t]||[];let e={};e[s]=$(n).val(),r[t].push(e)}}else r[i]=$(n).val()}}),this.find("input[type=checkbox]").each(function(e,t){let i=$(t).attr("name");void 0===r[i]&&-1==i.indexOf("[]")&&(r[i]="")}),this.find("input[type=radio]").each(function(e,t){$(t).prop("checked")&&(r[$(t).attr("name")]=$(t).val())}),this.find("input[type=radio]").each(function(e,t){t=$(t).attr("name");void 0===r[t]&&(r[t]="")}),this.find("select").each(function(e,n){if(""!=$(n).val()&&"-1"!=$(n).val()&&null!=$(n).val()){let e=$(n).attr("name");var s=$(n).val();let t=e,i="";if(void 0!==e){var a=e.indexOf(".");if(-1!=a&&(t=e.substr(0,a),i=e.substr(a+1,e.length-t.length-1)),"object"==typeof $(n).val())r[$(n).attr("name")]=$(n).val().join(",");else if(""!=i){let e={};e[i]=s,r[t]=e}else r[e]=s}}else $(n).val(),r[$(n).attr("name")]=""}),this.find("textarea").each(function(e,t){""!=$(t).val()?r[$(t).attr("name")]=$(t).val():r[$(t).attr("name")]=""}),r},utils={append:function(e,t,i){let n=dom.create("div");n.style.height="100%",n.style.width="100%",i=i||!1;let s=document.createRange();t=s.createContextualFragment(t);!1!==i&&(e.innerHTML=""),e.appendChild(n),n.appendChild(t);t=dom.find("[id^=page]",n);return t?n.setAttribute("page-id",t.id):n.setAttribute("page-id","page.not.in.database"),{id:t?t.id:"",container:n}},message:function(i){if(i||0!=i.length){let t="";for(let e=0;e<i.length;e++)t+=i[e].message+"<br>";return t}},prompt:function(t){if(t||0!=t.length)for(let e=0;e<t.length;e++)$(t[e].element).addClass("is-invalid")},render:function(e,t,i){t=document.getElementById(t).innerHTML;let n=Handlebars.compile(t);i=n(i);let s=document.getElementById(e);s.innerHTML=i},assemble:function(e,t){if("object"==typeof e)for(var i in e){var n=e[i];"object"==typeof n&&(e[i+"Id"]=n.id),"id"==i?e[t+"Id"]=n:"name"==i&&(e[t+"Name"]=n)}},in:function(e){var t=e.split(" ");let i=null,n=[];1==t.length?(i=document.getElementById(e),n.push(i)):(i=document.getElementById(t[0]),n=i.querySelectorAll(t[1]));for(let e=0;e<n.length;e++)i=n[e],i.addEventListener("animationend",function(){this.classList.remove("animated","fadeIn"),this.style.display="",this.removeEventListener("animationend",function(){}),this.removeEventListener("animationstart",function(){})}),i.classList.remove("fadeOut","hide"),i.classList.add("animated","fadeIn","show")},out:function(e){var t=e.split(" ");let i=null,n=[];1==t.length?(i=document.getElementById(e),n.push(i)):(i=document.getElementById(t[0]),n=i.querySelectorAll(t[1]));for(let e=0;e<n.length;e++)i=n[e],i.addEventListener("animationend",function(){this.classList.remove("animated","fadeOut"),this.removeEventListener("animationend",function(){})}),i.classList.remove("fadeIn","show"),i.classList.add("animated","fadeOut","hide")},nameAttr:function(i){const n=[];let s="";for(let t=0;t<i.length;t++){let e=i.charAt(t);e==e.toUpperCase()?(n.push(s),s="",s+=e.toLowerCase()):s+=e}return""!=s&&n.push(s),"data-model-"+n.join("-")},nameVar:function(t,e){if(-1==t.indexOf(e=e||"-"))return t;var i=t.split(e);let n="";for(let e=0;e<i.length;e++){const t=i[e];0==e?n+=t:n+=t.charAt(0).toUpperCase()+t.slice(1)}return n},camelcase:function(t,e){if(-1==t.indexOf(e))return t;var i=t.split(e);let n="";for(let e=0;e<i.length;e++){const t=i[e];0==e?n+=t:n+=t.charAt(0).toUpperCase()+t.slice(1)}return n},pascalcase:function(t,e){if(-1==t.indexOf(e))return t.charAt(0).toUpperCase()+t.slice(1);var i=t.split(e);let n="";for(let e=0;e<i.length;e++){const t=i[e];n+=t.charAt(0).toUpperCase()+t.slice(1)}return n},clone:function(e,t){for(var i in e=e||{})t[i]=e[i]},get:function(t){var i=Array.prototype.slice.call(arguments,1);let n={};for(let e=0;e<i.length;e++)n[i[e]]=t[i[e]];return n},isEmpty:function(e){let t=0;for(var i in e)t++;return 0==t},isBlank:function(e){let t=0;for(var i in e)null!=e[i]&&""!==e[i]&&t++;return 0==t},getParameter:function(e,t){t=t.replace(/[\[\]]/g,"\\$&");let i=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)"),n=i.exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},getParameters:function(e){if(-1==e.indexOf("?"))return{};let i={},n=(e=e.substring(e.indexOf("?")+1)).split("&");for(let t=0;t<n.length;t++){let e=n[t].split("=");if(1==e.length)return{};i[e[0].trim()]=decodeURIComponent(e[1].trim())}return i},isExisting:(t,i,n)=>{for(let e=0;e<t.length;e++)if(t[e][n]===i[n])return!0;return!1},textSize:(e,t)=>{const i=document.createElement("canvas"),n=i.getContext("2d");n.font=t;e=n.measureText(e);return console.log(e),i.remove(),{width:e.width,height:e.height}}},DataSheet.prototype.root=function(s){s=s||{};let a=this;this.table=dom.create("table","table","table-bordered");let e=dom.create("thead");this.tbody=dom.create("tbody");let t=dom.create("tr"),i=dom.create("th");i.style.borderBottomWidth="0",i.style.width=this.rowHeaderWidth+"px",e.appendChild(t),this.table.appendChild(e),this.table.appendChild(this.tbody);for(let e=0;e<this.columns.length;e++){var n=this.columns[e];i=dom.create("th","text-center"),i.style.borderBottomWidth="0",i.innerHTML=n.title,t.appendChild(i)}for(let n=0;n<this.rowCount;n++){var o=this.rowHeaders[n];let t=dom.create("tr"),i=dom.create("td");i.innerHTML=o.title,i.style.fontWeight="bold",t.appendChild(i);for(let e=0;e<this.columnCount;e++){var r=this.columns[e];i=dom.create("td"),i.style.textAlign="right",i.style.padding="6px 12px",i.setAttribute("data-ds-format",r.format||""),i.setAttribute("data-ds-row",n),i.setAttribute("data-ds-column",e),i.addEventListener("focus",function(){}),s[o.title]&&s[o.title][r.title]?i.innerHTML=s[o.title][r.title]:i.innerHTML="",i.addEventListener("keyup",function(e){var t=parseInt(this.getAttribute("data-ds-row")),i=parseInt(this.getAttribute("data-ds-column"));let n=null;if(13==e.keyCode)n=this;else if(37==e.keyCode){if(0==i)return;n=a.getCell(t,i-1)}else if(38==e.keyCode){if(0==t)return;n=a.getCell(t-1,i)}else if(39==e.keyCode){if(i==a.columnCount-1)return;n=a.getCell(t,i+1)}else if(40==e.keyCode){if(t==a.rowCount-1)return;n=a.getCell(t+1,i)}a.totalize(),null!=n&&(this.blur(),n.focus(),document.execCommand("selectAll",!1,null))}),t.appendChild(i)}this.tbody.appendChild(t)}if(0<this.totalColumns.length){let t=dom.create("tr"),i=dom.create("td");i.innerHTML="合计",i.style.fontWeight="bold",t.appendChild(i);for(let e=0;e<this.columnCount;e++)i=dom.create("td"),t.appendChild(i);this.tbody.appendChild(t)}return this.totalize(),this.table},DataSheet.prototype.getCell=function(t,i){var n=dom.find("tbody",this.table);let s=null;for(let e=0;e<n.children.length;e++){var a=n.children[e];if(e==t){for(let e=1;e<a.children.length;e++)if(e-1==i){s=a.children[e];break}break}}return s},DataSheet.prototype.render=function(e,t){this.container=dom.find(e),this.container.innerHTML="";e=dom.element(`
    <table class="table table-bordered">
      <thead></thead>
      <tbody></tbody>
    </table>
  `);let i=dom.find("thead",e),n=dom.find("tbody",e);this.rowHeaderRowCount,this.colHeaderRowCount;let s=[];for(let e=0;e<this.colHeaderRowCount;e++){var a=dom.create("tr");s.push(a),i.appendChild(a)}for(let i=0;i<this.colHeaderRowCount;i++){let t=s[i];for(let e=0;e<this.colHeaderColumnCount;e++){var o=this.matrixColumn[i][e];if(null!=o){let e=dom.create("th","text-center");e.style="border-bottom-width: 1px;",e.setAttribute("colspan",this.getSpanColumnCount(o)),e.innerHTML=o.title,t.appendChild(e)}}}for(let i=0;i<this.rowHeaderRowCount;i++){let t=dom.create("tr");for(let e=0;e<this.rowHeaderColumnCount;e++){var r=this.matrixRowHeader[e][i];if(null!=r){let i=dom.create("td");i.style="vertical-align: middle;",i.setAttribute("rowspan",this.getSpanRowCount(r)),i.innerHTML="<strong>"+r.title+"</strong>",this.onRowHeaderClicked&&(i.onclick=e=>{let t=Array.prototype.slice.call(i.parentElement.children);this.onRowHeaderClicked(i,t.indexOf(i))}),t.appendChild(i)}}for(let e=0;e<this.colHeaderColumnCount-this.rowHeaderColumnCount;e++){let i=dom.create("td");i.style.textAlign="right",i.style.padding="6px 12px",this.onCellClicked&&(i.onclick=e=>{let t=Array.prototype.slice.call(i.parentElement.children);this.onCellClicked(i,t.indexOf(i))}),t.appendChild(i)}n.appendChild(t)}this.container.appendChild(e)},DataSheet.prototype.getValues=function(){let i={};for(let t=0;t<this.rowHeaders.length;t++){var n=this.rowHeaders[t];i[n.title]={};for(let e=0;e<this.columns.length;e++){var s=this.columns[e];i[n.title][s.title]=this.tbody.rows[t].cells[e+1].innerText.trim()}}return i},DataSheet.prototype.totalize=function(){if(0!=this.totalColumns.length){let e=this.tbody.children[this.tbody.children.length-1];for(let n=0;n<this.columns.length;n++)if(!0===this.columns[n].totalable){let t=0,i=!1;for(let e=0;e<this.rowHeaders.length;e++){var s=parseFloat(this.tbody.rows[e].cells[n+1].innerText.trim());isNaN(s)||(t+=s,i=!0)}isNaN(t)||!0!==i||(e.cells[n+1].innerText=t.toFixed(2))}}},DataSheet.prototype.buildColumnMatrix=function(i,n,s){if(i){let t;n[s]?t=n[s]:(t=[],n.push(t));for(let e=0;e<i.length;e++){var a=i[e];t.push(a);var o=this.getSpanColumnCount(a);for(let e=1;e<o;e++)t.push(null);this.buildColumnMatrix(a.children,n,s+1)}}},DataSheet.prototype.buildRowHeaderMatrix=function(i,n,s){if(i){let t;n[s]?t=n[s]:(t=[],n.push(t));for(let e=0;e<i.length;e++){var a=i[e];t.push(a);var o=this.getSpanRowCount(a);for(let e=1;e<o;e++)t.push(null);this.buildRowHeaderMatrix(a.children,n,s+1)}}},DataSheet.prototype.getSpanColumnCount=function(t){let i=0;if(!t.children||0==t.children.length)return 1;for(let e=0;e<t.children.length;e++)i+=this.getSpanColumnCount(t.children[e]);return i},DataSheet.prototype.getSpanRowCount=function(e){return e.children&&0!=e.children.length?e.children.length:1},DataSheet.prototype.getRowCount=function(t){let i=0;for(let e=0;e<t.length;e++){var n=t[e];i+=1,n.children&&(i+=this.getRowCount(n.children))}return i},DataSheet.prototype.getColumnCount=function(t){let i=0;for(let e=0;e<t.length;e++){var n=t[e];i+=1,n.children&&(i+=this.getColumnCount(n.children))}return i},DataSheet.prototype.getColumnHeaderRowCount=function(i){let n=1;for(let t=0;t<i.length;t++){let e=1;var s=i[t];s.children&&(e+=this.getColumnHeaderRowCount(s.children)),e>n&&(n=e)}return n},DataSheet.prototype.getRowHeaderRowCount=function(t){let i=0;for(let e=0;e<t.length;e++){var n=t[e];n.children?i+=this.getRowHeaderRowCount(n.children):i+=1}return i},DataSheet.prototype.getColumnHeaderColumnCount=function(t){let i=0;for(let e=0;e<t.length;e++){var n=t[e];n.children?i+=this.getColumnHeaderColumnCount(n.children):i+=1}return i},DataSheet.prototype.getRowHeaderColumnCount=function(i){let n=1;for(let t=0;t<i.length;t++){let e=1;var s=i[t];s.children&&(e+=this.getRowHeaderColumnCount(s.children)),e>n&&(n=e)}return n},Tabs.prototype.loadPage=function(e,t,i,n){let s=dom.templatize('<div data-tab-content-id="{{id}}"></div>',{id:e});void 0!==t&&ajax.view({url:t,containerId:s,success:n||function(){}}),!0===i&&(s.style.display="none"),this.content.appendChild(s)},Tabs.prototype.render=function(){let a=this;this.content&&(this.content.innerHTML=""),this.navigator.innerHTML="",this.slider=dom.element('<div class="slider position-absolute"></div>'),this.navigator.appendChild(this.slider),this.tabs.forEach((n,e)=>{n.style=n.style||"padding: 0 16px;",n.style+="min-width: "+(16*n.text.length+32)+"px;text-align: center;";let s=dom.templatize(`
      <div class="nav-item font-weight-bold mr-0 pointer" style="{{style}}"
           data-tab-url="{{{url}}}"
           data-tab-id="{{{id}}}" >{{{text}}}</div>
    `,n);a.navigator.appendChild(s),dom.bind(s,"click",t=>{if(!s.classList.contains(a.tabActiveClass)){for(let t=0;t<a.navigator.children.length;t++){let e=a.navigator.children[t];e.classList.remove(a.tabActiveClass)}if(a.content)for(let e=0;e<a.content.children.length;e++)a.content.children[e].style.display="none";a.activate(s),!0===this.autoClear&&(this.content.innerHTML="");let e=dom.find('div[data-tab-content-id="'+s.getAttribute("data-tab-id")+'"]',a.content);var i;null!=e?e.style.display="":n.onClicked?n.onClicked(t):(i=s.getAttribute("data-tab-id"),t=s.getAttribute("data-tab-url"),a.loadPage(i,t,!1,n.success))}}),!0===a.lazy?0==e&&(a.activate(s),n.onClicked?n.onClicked():a.loadPage(n.id,n.url,!1,n.success)):0==e?(a.activate(s),n.onClicked?n.onClicked():a.loadPage(n.id,n.url,!1,n.success)):n.onClicked?n.onClicked():a.loadPage(n.id,n.url,!0,n.success)})},Tabs.prototype.activate=function(e){e.classList.add(this.tabActiveClass),this.slider.style.width=e.clientWidth+"px",this.slider.style.left=e.offsetLeft+"px"},PaginationGrid.prototype.root=function(){let e=dom.element(`
    <div class="card">
      <div class="card-body">
        <div class="row" style="margin-left: -5px; margin-right: -5px;"></div>
      </div>
    </div>
  `);return this.rootBody=e.children[0].children[0],1==this.borderless&&(e.classList.add("b-a-0","mb-0"),e.children[0].classList.add("p-0")),e},PaginationGrid.prototype.request=function(t){let n=this;if(t=t||{},this.favourite){let e=dom.find("a[widget-id=toggleFavourite] i",this.container);e.classList.contains("fas")?t._favourite="true":t._favourite="false"}if(this.widgetFilter){var e,i=this.widgetFilter.getQuery();for(e in i)t[e]=i[e]}if(this.queryFilter){var s,a=this.queryFilter.getValues();for(s in a)t[s]=a[s]}for(var o in this.filters)t[o]=this.filters[o];t.start=this.start,t.limit=this.limit,xhr.post({url:this.url,usecase:this.usecase,data:t,success:function(e){n.total=e.total;var t=e.data;if(t)if(n.rootBody.innerHTML="",n.showPageNumber(),0!=t.length){for(let e=0;e<t.length;e++){var i=t[e];n.addRow(i,e)}n.addMore()}else{let e=n.rootBody;e.innerHTML='<div class="text-center pt-4 full-width">  <img width="48" height="48" src="img/kui/nodata.png" class="mb-2" style="opacity: 25%;">  <p style="opacity: 40%; color: black;">没有匹配的数据</p></div>'}}})},PaginationGrid.prototype.addRow=function(e,t){var i=dom.create("div","col-md-"+this.colspan);this.rootBody.appendChild(i),this.onRender(i,e,t)},PaginationGrid.prototype.replaceRow=function(t,i){if(this.rootBody.children[i]){let e=this.rootBody.children[i];e.innerHTML="",this.onRender(e,t,i)}},PaginationGrid.prototype.addMore=function(){if(this.start/this.limit+1!=this.lastPageNumber()){let t=this.rootBody.children[this.rootBody.children.length-1];if(t){let e=dom.element(`
    <div>
      <div class="card b-a-0">
        <div class="card-body">
          <a class="btn text-secondary font-56 position-absolute" style="top: calc(50% - 45px); left: calc(50% - 41px);">
            <i class="fas fa-ellipsis-h"></i>
          </a>
        </div>
      </div>
    </div>
  `);dom.bind(dom.find("a",e),"click",e=>{this.next()});var i=t.getBoundingClientRect().height;e.classList.add(t.classList),e.children[0].children[0].style.height=i-15+"px",this.rootBody.appendChild(e)}}},PaginationGrid.prototype.render=function(e,t){this.container="string"==typeof e?document.querySelector(e):e,this.container.innerHTML="";let i=this.root();this.container.appendChild(this.actionbar()),this.container.appendChild(i),this.container.appendChild(this.pagination());e=dom.top(this.container);i.style.height="calc(100% - 20px - "+e+"px)",this.request(t=t||{})},PaginationGrid.prototype.actionbar=function(){let i=this,e=$('<div class="full-width d-flex overflow-hidden mb-3" style="height: 26px;"></div>');this.queryFilter?e.append(this.queryFilter.getRoot()):e.append(dom.element('<div class="full-width"></div>'));let n=e.get(0);if(this.favourite){let t=dom.element('<a widget-id="toggleFavourite" class="card-header-action text-yellow">\n  <i class="far fa-star position-relative font-16" style="top: 4px;"></i>\n</a>');n.appendChild(t),dom.bind(t,"click",function(){let e=dom.find("i",t);e.classList.contains("far")?(e.classList.remove("far"),e.classList.add("fas"),i.go(1,{_favourite:"true"})):(e.classList.remove("fas"),e.classList.add("far"),i.go(1,{_favourite:"false"}))})}if(this.widgetFilter){let t=dom.create("div","card","widget-query","fade","fadeIn");this.widgetFilter.render(t),this.container.appendChild(t);var s=dom.element('<a widget-id="toggleFilter" class="card-header-action text-primary">\n  <i class="fas fa-filter position-relative" style="top: 4px;"></i>\n</a>');dom.bind(s,"click",function(){let e=t;e.classList.contains("show")?e.classList.remove("show"):e.classList.add("show")})}this.group&&(s=dom.element('<a widget-id="toggleGroup" class="card-header-action">\n  <i class="fas fa-bars"></i>\n</a>'),n.appendChild(s)),this.sort&&(t=dom.element('<a widget-id="toggleSort" class="card-header-action">\n  <i class="fas fa-sort-amount-down-alt position-relative" style="top: 4px; font-size: 17px;"></i>\n</a>'),n.appendChild(t));var t=dom.element('<a widget-id="toggleFilter" class="card-header-action text-primary ml-2">\n  <i class="fas fa-sync-alt position-relative" style="top: 3px;"></i>\n</a>');return dom.bind(t,"click",function(){i.request()}),n.appendChild(t),e.get(0)},PaginationGrid.prototype.pagination=function(){let e=this,t=dom.create("div","full-width","d-flex");t.style.top="0",t.style.overflow="hidden",t.style.zIndex=900;let i=dom.create("ul","pagination","mb-0");i.style.marginLeft="auto",this.firstPage=dom.create("li","page-item");let n=dom.create("a","page-link","b-a-0","pt-0","font-14");return n.setAttribute("href","javascript:void(0)"),n.style.paddingBottom="0px",n.style.lineHeight="32px",n.style.height="32px",n.innerHTML='<i class="material-icons">first_page</i>',dom.bind(n,"click",function(){e.go(1)}),this.firstPage.appendChild(n),i.appendChild(this.firstPage),this.prevPage=dom.create("li","page-item"),n=dom.create("a","page-link","b-a-0","pt-0","font-14"),n.setAttribute("href","javascript:void(0)"),n.style.paddingBottom="0px",n.style.lineHeight="32px",n.style.height="32px",n.innerHTML='<i class="material-icons">chevron_left</i>',dom.bind(n,"click",function(){e.prev()}),this.prevPage.appendChild(n),i.appendChild(this.prevPage),li=dom.create("li","page-item","disabled"),li.style.paddingTop="4px",this.pagebar=dom.create("a","page-link","b-a-0","pt-0","font-14"),this.pagebar.setAttribute("href","javascript:void(0)"),this.pagebar.style.cursor="default",this.pagebar.style.paddingBottom="0px",this.pagebar.innerText="0/0",li.appendChild(this.pagebar),i.appendChild(li),this.nextPage=dom.create("li","page-item"),n=dom.create("a","page-link","b-a-0","pt-0","font-14"),n.setAttribute("href","javascript:void(0)"),n.style.paddingBottom="0px",n.style.lineHeight="32px",n.style.height="32px",n.innerHTML='<i class="material-icons">chevron_right</i>',dom.bind(n,"click",function(){e.next()}),this.nextPage.appendChild(n),i.appendChild(this.nextPage),this.lastPage=dom.create("li","page-item"),n=dom.create("a","page-link","b-a-0","pt-0","font-14"),n.setAttribute("href","javascript:void(0)"),n.style.paddingBottom="0px",n.style.lineHeight="32px",n.style.height="32px",n.innerHTML='<i class="material-icons">last_page</i>',dom.bind(n,"click",function(){e.go(e.lastPageNumber())}),this.lastPage.appendChild(n),i.append(this.lastPage),0<this.limit&&t.appendChild(i),t},PaginationGrid.prototype.lastPageNumber=function(){return 0==this.total||-1==this.limit?1:0==this.total%this.limit?parseInt(this.total/this.limit):parseInt(this.total/this.limit+1)},PaginationGrid.prototype.prev=function(){this.start<=0||this.go((this.start-this.limit)/this.limit+1)},PaginationGrid.prototype.next=function(){this.start+this.limit>=this.total||this.go((this.start+this.limit)/this.limit+1)},PaginationGrid.prototype.go=function(e,t){e<=0||e>this.lastPageNumber()||(this.start=this.limit*(e-1),this.request(t))},PaginationGrid.prototype.showPageNumber=function(){var e=this.start/this.limit+1;let t=this.lastPageNumber(),i=this.total;t=t||0,i=i||0,this.limit<=0||(this.pagebar.innerHTML=e+"/"+t+"&nbsp;&nbsp;共"+i+"条记录",this.firstPage.classList.remove("disabled"),this.prevPage.classList.remove("disabled"),this.nextPage.classList.remove("disabled"),this.lastPage.classList.remove("disabled"),1==e&&(this.firstPage.classList.add("disabled"),this.prevPage.classList.add("disabled")),e==this.lastPageNumber()&&(this.nextPage.classList.add("disabled"),this.lastPage.classList.add("disabled")))},PaginationGrid.skeleton=function(){return dom.element(`
    <div style="display: flex; flex-wrap: wrap; margin: 0px -8px; width: 100%;">
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
          <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
          </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
      <div style="flex-basis: 25%; margin-bottom: 24px; padding: 0px 8px;">
        <div style="background-color: rgba(0, 0, 0, 0.3); border-radius: 2px; height: 80px; width: 100%;">
        </div>
      </div>
    </div>
  `)},Timeline.prototype.createTile=function(e,t){var i,n=dom.element(`
    <li class="timeline-item">
      <div class="time"></div>
      <div class="small text-muted"></div>
      <p></p>
    </li>
  `);let s=n.children[0],a=n.children[1],o=n.children[2];return this.fnTitle&&(void 0===(i=this.fnTitle(e,t))?s.innerHTML="":"string"==typeof i||"number"==typeof i?s.innerHTML=i:s.appendChild(i)),this.fnSubtitle&&(void 0===(i=this.fnSubtitle(e,t))?a.innerHTML="":"string"==typeof i||"number"==typeof i?a.innerHTML=i:a.appendChild(i)),this.fnContent&&(void 0===(t=this.fnContent(e,t))?o.innerHTML="":"string"==typeof t||"number"==typeof t?o.innerHTML=t:o.appendChild(t)),n},Timeline.prototype.render=function(e,t){let i=this;this.container="string"==typeof e?document.querySelector(e):e,this.container.innerHTML="",t=t||{};let n=dom.create("ul","timeline-simple");this.container.appendChild(n);e={};if(utils.clone(this.params,e),utils.clone(t,e),this.url)xhr.post({url:this.url,params:e,success:function(e){if(e.data){var t=e.data;for(let e=0;e<t.length;e++)n.appendChild(i.createTile(t[e],e))}}});else for(let e=0;e<i.data.length;e++)n.appendChild(i.createTile(i.data[e],e));i.onComplete&&i.onComplete()},ListView.prototype.fetch=async function(e){var t={};e=e||{},utils.clone(this.params,t),utils.clone(e,t);this.url&&(this.data=this.data||{},this.data.start=this.start,this.data.limit=this.limit,t=await xhr.promise({url:this.url,params:t}),Array.prototype.push.apply(this.local,t)),0==this.local.length?this.emptyHtml&&(this.container.innerHTML=this.emptyHtml):this.append(this.local)},ListView.prototype.render=function(t,e){this.container="string"==typeof t?document.querySelector(t):t,this.container.innerHTML="";t=this.height-37;if(this.onFilter){let e=dom.element(`
      <div class="input-group position-sticky" style="top: 0; left: 0; z-index: 10;">
        <div class="input-group-prepend">
          <span class="input-group-text" style="border-bottom-left-radius: unset;">
            <i class="fas fa-search"></i>
          </span>
        </div>
        <input class="form-control" placeholder="搜索..."  style="border-bottom-right-radius: unset;">
        <div class="input-group-append">
          <span class="input-group-text pointer text-primary" style="border-bottom-right-radius: unset;">
            <i class="fas fa-plus"></i>
          </span>
          <span class="input-group-text" style="border-bottom-right-radius: unset;">
            <i class="fas fa-question icon-general"></i>
          </span>
          <span class="input-group-text" style="border-bottom-right-radius: unset;">
            <i class="fas fa-asterisk icon-required"></i>
          </span>
        </div>
      </div>
    `),t=dom.find("input",e);dom.bind(t,"input",e=>{clearTimeout(this.delayToSearch),this.delayToSearch=setTimeout(()=>{this.onFilter(this,t.value)},500)}),this.required||e.children[2].children[2].remove(),this.tooltip||e.children[2].children[1].remove(),this.onAdd||e.children[2].children[0].remove(),0==e.children[2].children.length&&e.children[2].remove(),this.container.appendChild(e)}let i=dom.create("ul","list-group","full-width");if(this.borderless&&i.classList.add("b-a-0"),this.onFilter){let e=dom.create("div");e.style.height=t+"px",e.style.overflowY="auto",e.style.border="1px solid rgba(0, 0, 0, 0.125)",e.style.borderTop="",e.appendChild(i),this.container.appendChild(e)}else this.container.appendChild(i);!1!==e&&!0!==this.lazy&&this.reload()},ListView.prototype.reload=function(e){e=e||{};let t=dom.find("ul",this.container);t.innerHTML="",this.start=0,this.url&&(this.local=[]),this.fetch(e)},ListView.prototype.load=function(){this.start=this.local.length,this.fetch()},ListView.prototype.remove=function(i){if(this.idField){var n=dom.find("ul",this.container);for(let t=0;t<n.children.length;t++){let e=n.children[t];dom.model(e)[this.idField]===i[this.idField]&&e.remove()}}},ListView.prototype.append=function(t,i){let n=this,a=this.container.querySelector("ul");var o=a.querySelectorAll("li").length;if(Array.isArray(t)){var s=t;for(let e=0;e<s.length;e++)this.append(s[e]);n.complete&&n.complete(t)}else{var r=t;if(this.idField)for(let e=0;e<a.children.length;e++){var l=a.children[e];if(dom.model(l)[this.idField]===r[this.idField])return}let s=dom.create("li","list-group-item");!1!==this.hoverable&&s.classList.add("list-group-item-action"),!0===this.activateable&&dom.bind(s,"click",e=>{for(let t=0;t<s.parentElement.children.length;t++){let e=s.parentElement.children[t];e.classList.remove("active")}s.classList.add("active")});for(let e=0;e<this.itemClass.length;e++)s.classList.add(this.itemClass[e]);this.borderless&&s.classList.add("b-a-0"),this.onClick&&dom.bind(s,"click",this.onClick),s.style.paddingLeft="16px",s.style.paddingRight="16px",s.style.paddingTop="8px",s.style.paddingBottom="8px",s.style.display="flex",s.style.alignItems="center",this.onFilter&&(s.style.borderLeftWidth="0",s.style.borderRightWidth="0",s.style.borderBottomWidth="0");let e=this.create(o,r,s);if(e.style.width="100%",this.onCheck){let t=dom.element(`
        <input class="pointer checkbox color-info is-outline mr-2" type="checkbox">
      `);for(let e=0;e<this.selections.length;e++)if(this.compare(this.selections[e],r)){t.setAttribute("checked",!0);break}dom.bind(t,"change",function(){n.onCheck(this.checked,dom.model(this),this)}),dom.model(t,r),s.appendChild(t)}if(s.appendChild(e),0<this.slidingActions.length){this.actionElements=[];for(let t=0;t<this.slidingActions.length;t++){let e=this.slidingActions[t];e.width=parseInt(e.width||64),s.appendChild(e.create())}dom.bind(s,"touchstart",e=>{this.touchStartX=e.touches[0].screenX,this.touchStartY=e.touches[0].screenY}),dom.bind(s,"touchmove",e=>{this.touchMoveX=e.touches[0].screenX,this.touchMoveY=e.touches[0].screenY;let i=this.touchStartX-this.touchMoveX;e=this.touchStartY-this.touchMoveY;if(!(Math.abs(i)<30||30<Math.abs(e)))if(0<i){let t=i/this.slidingActions.length;for(let e=1;e<s.children.length;e++)s.children[e].getBoundingClientRect().width>=this.slidingActions[e-1].width||(t>=this.slidingActions[e-1].width&&(t=this.slidingActions[e-1].width),s.children[e].style.minWidth=t+"px",s.children[e].style.display="")}else{i=-i/10;var n=i/this.slidingActions.length;for(let t=1;t<s.children.length;t++){let e=s.children[t].getBoundingClientRect().width-n;e=e<=5?0:e,0==e?(s.children[t].style.width="0",s.children[t].style.minWidth="unset"):s.children[t].style.minWidth=e+"px"}}}),dom.bind(s,"touchend",e=>{this.touchendX=e.changedTouches[0].screenX,this.touchendY=e.changedTouches[0].screenY;var t=this.touchStartX-this.touchendX,e=this.touchStartY-this.touchendY;Math.abs(t)<30||30<Math.abs(e)||(30<=t?this.expandSlidingActions(s):this.collapseSlidingActions(s))})}this.idField&&s.setAttribute("data-list-item-id",r[this.idField]),dom.model(s,r),"number"==typeof i?i<0?a.insertBefore(s,a.children[a.children.length+i]):a.insertBefore(s,a.children[i]):a.appendChild(s),this.onRemove&&(i=dom.element(`
        <a class="btn text-danger float-right font-18" style="padding: 0; margin-left: auto;">
          <i class="fas fa-times" style=""></i>
        </a>
      `),dom.bind(i,"click",function(e){e.stopPropagation(),n.onRemove(this.parentElement,dom.model(this.parentElement))}),dom.model(i,r),s.appendChild(i)),this.onReorder?this.setReorderable(s):this.draggable&&(s.setAttribute("draggable","true"),s.addEventListener("dragover",function(e){e.preventDefault()}),s.addEventListener("dragstart",function(e){}))}},ListView.prototype.replace=function(i){var n=this.container.querySelector("ul");for(let t=0;t<n.children.length;t++){let e=n.children[t];if(dom.model(e)[this.idField]===i[this.idField]){dom.model(e,i),e.innerHTML="",e.appendChild(this.create(t,i));break}}},ListView.prototype.search=function(i){var n=this.container.querySelector("ul");for(let t=0;t<n.children.length;t++){let e=n.children[t];-1!=e.innerText.indexOf(i)?e.style.display="":e.style.display="none"}},ListView.prototype.setReorderable=function(e){let t=dom.find("ul",this.container);t.addEventListener("dragover",function(e){e.preventDefault()}),t.ondrop=e=>{this.onReorder&&this.onReorder(dom.model(this.draggingElement),this.getItemIndex(this.draggingElement),this.draggingElementOriginalIndex),this.draggingElement.style.opacity="",this.draggingElement=null,this.clonedDraggingElement=null},e.setAttribute("draggable","true"),e.ondragover=e=>{var t,i=dom.ancestor(e.target,"li");let n=i.parentElement;i!=this.draggingElement&&((t=this.getItemIndex(i))<this.draggingElementIndex?n.insertBefore(this.draggingElement,i):t>this.draggingElementIndex&&(null==i.nextElementSibling?n.appendChild(this.draggingElement):n.insertBefore(this.draggingElement,i.nextElementSibling)),this.draggingElementIndex=t,e.preventDefault())},e.ondragstart=e=>{let t=dom.ancestor(e.target,"li");t.parentElement,e.layerX;var i=e.layerY,i=e.target.offsetTop+i;this.clonedDraggingElement=t.cloneNode(!0),this.draggingElement=t,this.draggingElement.style.opacity="0.3",this.draggingElementIndex=this.getItemIndex(t),this.draggingElementOriginalIndex=this.draggingElementIndex,e.dataTransfer.setData("id",t.getAttribute("data-list-item-id")),e.dataTransfer.setData("y",i)}},ListView.prototype.getItemIndex=function(t){var i=t.parentElement;for(let e=0;e<i.children.length;e++)if(t==i.children[e])return e},ListView.prototype.setHeight=function(e){let t=this.container.querySelector("ul");t.style.height=e+"px"},ListView.prototype.activate=function(e){let t=this.container.querySelector("ul");for(let e=0;e<t.children.length;e++)t.children[e].classList.remove("active");e.classList.add("active")},ListView.prototype.expandSlidingActions=function(t){if(!(t.children[1].getBoundingClientRect().width>=this.slidingActions[0].width.width)){let e=i=>{for(let t=1;t<i.children.length;t++){let e=i.children[t];var n=e.getBoundingClientRect();n.width+5>=this.slidingActions[t-1].width?(e.style.minWidth=this.slidingActions[t-1].width+"px",clearInterval(this.interval4SlidingActions)):e.style.minWidth=n.width+5+"px"}};this.interval4SlidingActions=setInterval(()=>{e(t)},5)}},ListView.prototype.collapseSlidingActions=function(n){n.children[1].getBoundingClientRect().width<=0||(this.interval4SlidingActions=setInterval(()=>{for(let t=1;t<n.children.length;t++){let e=n.children[t];var i=e.getBoundingClientRect();i.width-5<=0?(e.style.width="0",e.style.minWidth="unset",e.style.display="none",clearInterval(this.interval4SlidingActions)):e.style.minWidth=i.width-5+"px"}},10))},ListView.prototype.subscribe=function(e,t){},Wizard.prototype.render=function(e,t){this.container=dom.find(e),this.body=dom.find("div.tab-content",this.root);let n=dom.find("div.steps",this.root);for(let i=0;i<this.steps.length;i++){let e=this.steps[i],t=dom.element(`
      <div class="step" widget-on-render="" data-step="${i}" style="cursor: pointer;">
        <div class="content">
          <div class="title"></div>
          <div class="description"></div>
        </div>
      </div>
    `);e.index=i,e.active&&(this.current=e),null==this.current&&t.classList.add("completed"),dom.find("div.title",t).innerHTML=e.title,dom.find("div.description",t).innerHTML=e.description,n.appendChild(t)}this.container.appendChild(this.root),this.display(this.current)},Wizard.prototype.display=function(i){let t=this,e=dom.find('div.step[data-step="'+i.index+'"]',this.root);e.classList.remove("completed"),e.classList.add("active");let n=!1;for(let t=0;t<this.body.children.length;t++){let e=this.body.children[t];e.getAttribute("data-page-url")==i.url?(n=!0,e.classList.add("active")):e.classList.remove("active")}var s;n||(s=dom.create("div","tab-pane","active"),this.body.appendChild(s),ajax.view({url:i.url,page:i.page,containerId:s,success:function(e){t.body.children[t.body.children.length-1].setAttribute("data-page-url",i.url)}}))},Wizard.prototype.commit=function(){let e=dom.find("div.step.active",this.root);var t=parseInt(e.getAttribute("data-step"));e.classList.remove("active"),e.classList.add("completed"),this.display(this.steps[t+1])},Wizard.prototype.rollback=function(){let e=dom.find("div.step.active",this.container);var t=parseInt(e.getAttribute("data-step"));e.classList.remove("active"),this.display(this.steps[t-1])},Chat.MESSAGE_TYPE_TEXT="TEXT",Chat.MESSAGE_TYPE_IMAGE="IMAGE",Chat.MESSAGE_TYPE_AUDIO="AUDIO",Chat.MESSAGE_TYPE_VIDEO="VIDEO",Chat.MESSAGE_TYPE_PATIENT="PATIENT",Chat.MESSAGE_TYPE_CUSTOM="CUSTOM",Chat.MESSAGE_STATUS_UNREAD="01",Chat.MESSAGE_STATUS_READ="02",Chat.MESSAGE_STATUS_REVOKE="90",Chat.prototype.init=async function(e){await this.onInit();this.scheduleName=e;var t=this.userId+"@"+this.userType,i=await xhr.promise({url:this.host+"/api/v3/common/script/tim/user_signature",params:{userId:t}}),e={SDKAppID:i.appId};this.tim=TIM.create(e),this.tim.setLogLevel(1),this.tim.registerPlugin({"tim-upload-plugin":TIMUploadPlugin}),this.tim.login({userID:t,userSig:i.signature}),this.tim.on(TIM.EVENT.SDK_READY,function(e){}),this.tim.on(TIM.EVENT.MESSAGE_RECEIVED,s=>{for(let n=0;n<s.data.length;n++){let e=s.data[n],t=Chat.MESSAGE_TYPE_TEXT,i=null;"TIMCustomElem"===e.type?(i=JSON.parse(e.payload.data).messageContent,i.imagepath?t=Chat.MESSAGE_TYPE_IMAGE:i.audiopath?t=Chat.MESSAGE_TYPE_AUDIO:i.archiveId&&(t=Chat.MESSAGE_TYPE_PATIENT)):i=e.payload.text,this.onMessageReceived({senderId:e.conversationID.substring(3),messageTime:moment(1e3*s.data[n].time).format("YYYY-MM-DD HH:mm"),messageType:t,messageContent:i})}})},Chat.prototype.getConversations=async function(){var e,t=await xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{status:Chat.MESSAGE_STATUS_UNREAD,receiverId:this.userId}});let i={};for(let e=0;e<t.length;e++){var n=t[e],s=n.senderId+"#"+n.senderType;if(i[s]){let e=i[s];e.createTime=n.createTime,e.messages.push(n)}else{let e={messages:[]};i[s]=e,e.id=s,e.createTime=n.createTime,e.name=n.senderType,e.senderId=n.senderId,e.senderType=n.senderType,e.messages.push(n)}}let a=[];for(e in i)a.push(i[e]);return a},Chat.prototype.fetchMessages=async function(e,t,i){let n="";n=e>this.userId?e+"&"+this.userId:this.userId+"&"+e;var s=await xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{conversationId:n,_order_by:"messageTime asc"}});let a=[],o=null;for(let n=0;n<s.length;n++){var r=s[n],l=moment(r.createTime).format("YYYY-MM-DD HH:mm");l!=o&&(o=l,a.push({createTime:l,groupingMessages:[{direction:r.senderId==this.userId?"outgoing":"incoming",messages:[]}]}));let e=a[a.length-1],t=e.groupingMessages[e.groupingMessages.length-1],i="";i=r.senderId==this.userId?"outgoing":"incoming",t.direction===i?t.messages.push(r):e.groupingMessages.push({direction:i,messages:[r]})}return a},Chat.prototype.fetchUnreadMessages=function(){let t=this;xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{status:Chat.MESSAGE_STATUS_UNREAD,receiverId:this.userId,receiverType:this.userType}}).then(e=>{t.onUnreadMessages(e)})},Chat.prototype.sendMessage=async function(e,t,i,n,s){return s=s||this.userId+"&"+e,"string"==typeof n&&(n=n.replace("\\","\\\\")),xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/save",params:{conversationId:s,senderId:this.userId,senderType:this.userType,receiverId:e,receiverType:t,messageType:i,messageTime:"now",messageContent:n,createTime:"now",status:Chat.MESSAGE_STATUS_UNREAD,"||stdbiz/pim/conversation/merge":{conversationId:s,conversationName:s,unreadCount:1,lastConversationTime:"now"}}})},Chat.prototype.sendTextMessage=async function(e,t,i,n){var s=e+"@"+t,n=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_TEXT,i,n),i=this.tim.createTextMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{id:n.conversationMessageId,text:i}});return this.tim.sendMessage(i)},Chat.prototype.sendImageMessage=async function(e,t,i,n){var s=e+"@"+t,i=await xhr.promise({url:this.host+"/api/v3/common/image",params:{directoryKey:"chat",filedata:i.data.substring(i.data.indexOf(",")+1),fileext:i.ext}}),n=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_IMAGE,JSON.stringify({imagepath:i.filepath,thumbnail:i.thumbnail}),n),i=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_IMAGE,messageContent:{id:n.conversationMessageId,imagepath:i.filepath,thumbnail:i.thumbnail}})}});return this.tim.sendMessage(i)},Chat.prototype.sendAudioMessage=async function(e,t,i,n){var s=e+"@"+t,i=await xhr.promise({url:this.host+"/api/v3/common/audio",params:{directoryKey:"chat",filedata:i.data.substring(i.data.indexOf(",")+1),fileext:"ogg"}}),n=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_AUDIO,JSON.stringify({audiopath:i.filepath,duration:i.duration}),n),i=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_AUDIO,messageContent:{id:n.conversationMessageId,audiopath:i.filepath,duration:i.duration}})}});return this.tim.sendMessage(i)},Chat.prototype.sendPatientMessage=async function(e,t,i,n){var s=e+"@"+t,n=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_PATIENT,JSON.stringify(i),n);i.id=n.conversationMessageId;i=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_PATIENT,messageContent:i})}});return this.tim.sendMessage(i)},Chat.prototype.readMessages=function(e){let t=this;xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/update",params:{senderId:e,readTime:"now",status:Chat.MESSAGE_STATUS_READ}}).then(e=>{t.onReadMessages(e)})},Chat.prototype.revokeMessage=function(t){return xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/update",params:{messageId:t,status:Chat.MESSAGE_STATUS_REVOKE}}).then(e=>{this.onRevokeMessage(t)})},Chat.prototype.stop=function(){schedule.stop(this.scheduleName)},"undefined"!=typeof module&&(module.exports={Chat:Chat}),Handlebars.registerHelper("ifeq",function(e,t,i){return e==t?i.fn(this):i.inverse(this)}),kuit={main:e=>{var t=e.url;let i=utils.getParameters(e.url);i={...i,...e.params};let n=e.title||"",s=e.success;xhr.get({url:t,success:function(e){let t=document.createRange();e=t.createContextualFragment(e);document.body.innerHTML="",document.body.appendChild(e),s&&s(n,e,i)}})},view:e=>{let n=dom.find("#container");for(let e=0;e<n.children.length;e++){var t=n.children[e].getAttribute("page-id");window[t].destroy&&window[t].destroy()}n.innerHTML="";var i=e.url;let s=utils.getParameters(e.url);s={...s,...e.params};let a=e.title||"",o=e.success;xhr.get({url:i,success:function(e){let t=null;n&&(t=utils.append(n,e,!1)),o&&o(a,t,s);let i=dom.element(`
        <li class="active">${a}</li>
      `);pageMain.navPage.innerHTML="",pageMain.navPage.appendChild(i),window[t.id].show(s),setTimeout(()=>{i.classList.add("in"),window[t.id].page.classList.add("in")},100)}})},stack:function(e){let s=dom.find("#container");var t=e.url;let a=utils.getParameters(e.url);a={...a,...e.params};let o=e.title||"",r=e.success;for(let t=0;t<s.children.length;t++){let e=s.children[t];"DIV"==e.tagName&&"true"!=e.getAttribute("data-stack-back")&&(e.style.display="none")}xhr.get({url:t,success:function(e){let t=null;s&&(t=utils.append(s,e,!1)),r&&r(o,t,a);for(let t=0;t<pageMain.navPage.children.length;t++){let e=pageMain.navPage.children[t];var i=e.innerText;e.innerText="";i=dom.element('<a href="#">'+i+"</a>");e.appendChild(i),e.removeAttribute("class"),dom.bind(i,"click",kuit.switch),e.style.transform="unset"}let n=dom.element(`
        <li class="active">${o}</li>
      `);pageMain.navPage.appendChild(n),setTimeout(()=>{n.classList.add("in"),s.children[s.children.length-1].classList.add("out"),window[t.id].page.classList.add("in")},100),window[t.id].show(a)}})},switch:e=>{let i=dom.find("#container"),t=dom.ancestor(e.target,"li"),n=Array.prototype.slice.call(pageMain.navPage.children);var s=n.indexOf(t);for(let t=i.children.length-1;t>s;t--){let e=i.children[t];var a=e.getAttribute("page-id");window[a].destroy&&window[a].destroy(),n[t].remove(),e.remove()}e=t.innerText;t.classList.add("active"),t.innerHTML=e,i.children[s].style.display=""},rightbar:e=>{let t=dom.find(".rightbar"),i=dom.find("#overlay");t.classList.remove("out"),t.classList.add("in"),i.style.display="",i.onclick=e=>{t.classList.remove("in"),t.classList.add("out"),i.style.display="none"};var n=e.url;ajax.view({url:n,containerId:t,success:()=>{e.success&&e.success()}})}};