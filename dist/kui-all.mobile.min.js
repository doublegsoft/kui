xhr={},xhr.request=function(e,t){let n=e.url,i=e.data||e.params||{},s=e.type||"json",a=e.success,o=e.error;i={...utils.getParameters(e.url),...i};let l=e.usecase||"",r=new XMLHttpRequest;r.timeout=1e4,r.onload=function(){let e=r.responseText;if("json"==s)try{e=JSON.parse(e)}catch(t){return void(o&&o(e))}4==r.readyState&&"200"==r.status?a&&a(e):o&&o(e)},r.onerror=function(){o&&o({error:{code:-500,message:"网络访问错误！"}})},r.ontimeout=function(){o&&o({error:{code:-501,message:"网络请求超时！"}})},r.open(t,n,!0),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("usecase",l),"undefined"!=typeof APPTOKEN&&r.setRequestHeader("apptoken",APPTOKEN),window.user?r.setRequestHeader("_current_user",window.user.userId):r.setRequestHeader("_current_user","unauthorized user"),i?r.send(JSON.stringify(i)):r.send(null)},xhr.get=function(e){let t=e.url,n=(e.data,e.success),i=e.error,s=new XMLHttpRequest;s.open("GET",t,!0),s.onload=function(){let e=s.responseText;4==s.readyState&&"200"==s.status?n&&n(e):i&&i(e)},s.send(null)},xhr.post=function(e){let t=e.url;"undefined"!=typeof HOST&&-1==t.indexOf("http")&&(t=HOST+t,e.url=t),xhr.request(e,"POST")},xhr.put=function(e){xhr.request(e,"PUT")},xhr.delete=function(e){xhr.request(e,"DELETE")},xhr.connect=function(e){xhr.request(e,"CONNECT")},xhr.upload=function(e){let t=e.url,n=e.data||e.params,i=e.type||"json",s=e.success,a=e.error,o=new FormData;for(let e in n)o.append(e,n[e]);o.append("file",e.file);let l=new XMLHttpRequest;l.timeout=1e4,l.onload=function(){let e=l.responseText;if("json"==i)try{e=JSON.parse(e)}catch(t){return void(a&&a(e))}4==l.readyState&&"200"==l.status?s&&s(e):a&&a(e)},e.progress&&(l.onprogress=function(t){e.progress(t.loaded,t.total)}),l.onerror=function(){a&&a({error:{code:-500,message:"网络访问错误！"}})},l.ontimeout=function(){a&&a({error:{code:-501,message:"网络请求超时！"}})},l.open("POST",t,!0),"undefined"!=typeof APPTOKEN&&l.setRequestHeader("apptoken",APPTOKEN),l.send(o)},xhr.chain=function(e){if(0==e.length)return;let t=e[0],n=t.success;xhr.promise(t,function(t){n(t),xhr.chain(e.slice(1))})},xhr.promise=function(e,t){return new Promise(function(n,i){e.success=function(e){if(e.error)return dialog.error(e.error.message),void(t&&t(e.error));n(e.data)},e.error=t,xhr.post(e)})},xhr.download=function(e){let t=new XMLHttpRequest;t.open("POST",e.url,!0),t.responseType="arraybuffer",t.onload=function(){if(200===this.status){let a="",o=t.getResponseHeader("Content-Disposition");if(o&&-1!==o.indexOf("attachment")){let e=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(o);null!=e&&e[1]&&(a=e[1].replace(/['"]/g,""))}let l=t.getResponseHeader("Content-Type"),r=new Blob([this.response],{type:l});if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(r,a);else{var n=window.URL||window.webkitURL,i=n.createObjectURL(r),s=document.createElement("a");void 0===s.download?window.location=i:(s.href=i,s.download=e.filename||"下载的文件",document.body.appendChild(s),s.click()),setTimeout(function(){n.revokeObjectURL(i)},100)}}},t.setRequestHeader("Content-type","application/json"),"undefined"!=typeof APPTOKEN&&t.setRequestHeader("apptoken",APPTOKEN),t.send(JSON.stringify(e.params||{}))},xhr.asyncRequest=function(e,t){let n=e.url,i=e.data||e.params,s=e.type||"json",a=e.usecase||"";return new Promise((e,o)=>{if(n){let l=new XMLHttpRequest;l.timeout=1e4,l.onload=function(){let t=l.responseText;if("json"==s)try{t=JSON.parse(t)}catch(e){return console.log(e),void o(e)}4==l.readyState&&"200"==l.status?e(t):o(t)},l.onerror=function(){o({error:{code:-500,message:"网络访问错误！"}})},l.ontimeout=function(){o({error:{code:-501,message:"网络请求超时！"}})},l.open(t,n,!0),l.setRequestHeader("Content-Type","application/json"),l.setRequestHeader("usecase",a),"undefined"!=typeof APPTOKEN&&l.setRequestHeader("apptoken",APPTOKEN),i?l.send(JSON.stringify(i)):l.send(null)}})},xhr.asyncPost=function(e){let t=e.url;return"undefined"!=typeof HOST&&-1==t.indexOf("http")&&(t=HOST+t,e.url=t),xhr.asyncRequest(e,"POST")},"undefined"!=typeof module&&(module.exports={xhr:xhr});var ajax={save:function(e){for(var t=e.url||"",n=e.form,i=e.button,s=e.success,a=n.validate(),o="",l=0;l<a.length;l++)o+=a[l].message+"<br>";if(""==o){i&&i.prop("disabled",!0);var r=n.formdata();$.ajax({url:t,data:r,method:"POST",dataType:"json",success:function(e){if(void 0!==e.error)return dialog.error("保存信息出错！"),void(i&&i.prop("disabled",!1));dialog.success("保存信息成功！"),void 0!==s&&s(e),i&&i.prop("disabled",!1)},error:function(){dialog.error("系统异常！"),i&&i.prop("disabled",!1)}})}else dialog.error(o)},post:function(e){let t={...utils.getParameters(e.url),...e.data};$.ajax({url:e.url,data:t,method:"POST",dataType:"json",success:function(t){void 0!==e.success&&e.success(t)}})},get:function(e){$.ajax({url:e.url,data:e.data,dataType:"json",success:function(t){void 0!==e.success&&e.success(t)}})},text:function(e,t,n){$.ajax({url:e,data:t,success:function(e){void 0!==n&&n(e)}})},view:function(e){"undefined"!=typeof schedule&&e.clear&&schedule.stop();let t=e.url,n=!1;n=void 0===e.empty||e.empty;let i=e.page;t&&0==t.indexOf(":")&&(i=t.substring(1),t=null);let s=utils.getParameters(e.url),a={...s,...e.params},o=e.title||"",l=e.containerId,r=e.success,d=null;if("string"==typeof l?null==(d=document.getElementById(l.trim()))&&(d=document.querySelector(l.trim())):d=l,void 0===a&&(a={}),window.parameters)for(let e in a)window.parameters[e]=a[e];t?xhr.get({url:t,success:function(t){let i=null;d&&(i=utils.append(d,t,n)),r&&r(o,i,s),!0!==e.initiative&&utils.isEmpty(s)||window[i.id].show(s)}}):i&&xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:i},success:function(e){let t=e.data.script;t||(t='<div class="full-width full-height d-flex"><img src="img/under-construction.jpeg" class="m-auto full-width"></div>');let i=null;d&&(i=utils.append(d,t,n)),r&&r(o,i,s)}})}};ajax.append=function(e){"undefined"!=typeof schedule&&e.clear&&schedule.stop();let t=dom.find("#tabsMain"),n=dom.find("#tabsOthers");if(null==t)return void ajax.view(e);let i=t.children.length,s=e.url,a=e.title||"",o=e.containerId,l=e.params,r=e.success,d=null;if("string"==typeof o?null==(d=document.getElementById(o.trim()))&&(d=document.querySelector(o.trim())):d=o,void 0===l&&(l={}),window.parameters)for(let e in l)window.parameters[e]=l[e];u();let c=d.querySelector('div[data-url="'+s+'"]');if(null!=c){c.classList.remove("hide"),setTimeout(function(){c.classList.add("show")},150);let e=dom.find('a[data-url="'+s+'"]',t);return null!=e?void e.classList.add("active"):void dom.find('a[data-url="'+s+'"]',n).classList.add("active")}function u(){d.querySelectorAll("div[data-url]").forEach(e=>{e.classList.remove("show"),e.classList.add("hide","fade","fadeIn")}),t.querySelectorAll("a.active").forEach(e=>{e.classList.remove("active")}),n.querySelectorAll("a.active").forEach(e=>{e.classList.remove("active")})}function m(e,s){if(""==e||null==t)return;let a=dom.element('\n      <li class="nav-item">\n        <a class="nav-link head-link">\n          <span></span>\n          <i class="fas fa-times-circle ml-1"></i>\n        </a>\n      </li>\n    ');dom.find("a",a).setAttribute("data-url",s),dom.bind(dom.find("i",a),"click",e=>{e.preventDefault(),e.stopPropagation();let i=e.target.parentElement,s=d.querySelector('div[data-url="'+i.getAttribute("data-url")+'"]');if(s&&s.remove(),e.target.parentElement.parentElement.remove(),d.querySelectorAll("div[data-url]").length>0&&t.children[0].click(),n.children.length>0){let e=n.children[0];e.remove(),function(e){dom.find("a",e).classList.add("nav-link"),dom.find("a",e).classList.remove("dropdown-item"),dom.find("i",e).classList.add("ml-1"),dom.find("i",e).classList.remove("float-right"),t.appendChild(e)}(e)}}),dom.bind(dom.find("a",a),"click",e=>{let t=dom.ancestor(e.target,"a");t.classList.contains("active")||(u(),t.classList.add("active"),p(r.getAttribute("data-url")))});let o=!1;if(t.querySelectorAll("li").forEach(t=>{dom.find("span",t).innerText==e&&(o=!0,dom.find("a",t).classList.add("active"))}),o)return;if(0==i)t.appendChild(a);else if(i+1>MAX_HEAD_LINK_COUNT){let e=dom.find("li:last-child",t);e.remove(),function(e){dom.find("a",e).classList.add("pointer"),dom.find("a",e).classList.remove("nav-link"),dom.find("a",e).classList.add("dropdown-item"),dom.find("i",e).classList.remove("ml-1"),dom.find("i",e).classList.add("float-right"),0==n.children.length?n.appendChild(e):n.insertBefore(e,n.children[0])}(e)}t.insertBefore(a,t.children[0]);let l=dom.find("span",a),r=dom.find("a",a);r.classList.add("active"),l.innerText=e}function p(e){d.querySelectorAll("div[data-url]").forEach(e=>{e.classList.remove("show"),e.classList.add("hide")});let i=d.querySelector('div[data-url="'+e+'"]');if(null!=i){i.classList.remove("hide"),setTimeout(function(){i.classList.add("show")},150);let s=dom.find('a[data-url="'+e+'"]',t);return null!=s?void s.classList.add("active"):void dom.find('a[data-url="'+e+'"]',n).classList.add("active")}xhr.get({url:e,success:function(t){utils.append(d,t,!1);for(let t=d.children.length-1;t>=0;t--){let n=d.children[t];if("DIV"==n.tagName){n.setAttribute("data-url",e),setTimeout(function(){n.classList.add("show")},150);break}}m(a,e),r&&r(a,t)}})}if(0==s.indexOf(":")){let e=s.substring(1);xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:e},success:function(t){let n=t.data.script;utils.append(d,n,!1);for(let e=d.children.length-1;e>=0;e--){let t=d.children[e];if("DIV"==t.tagName){t.setAttribute("data-url",s),setTimeout(function(){t.classList.add("show")},150);break}}m(a,s),stdbiz.render(e,d.querySelector('[data-url="'+s+'"]'),{})}})}else p(s)},ajax.shade=function(e){"undefined"!=typeof schedule&&schedule.stop();let t=e.url,n=e.success,i=document.querySelector(".page.full");null!=i&&i.parentElement.remove(),-1===t.indexOf(":")?xhr.get({url:t,success:function(t){let i=utils.append(document.body,t);n&&n(e.title||"",i)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:t.substring(1)},success:function(t){let i=t.data.script,s=utils.append(document.body,i);n&&n(e.title||"",s)}})},ajax.stack=function(e){"undefined"!=typeof schedule&&e.clear&&schedule.stop();let t=e.pageId,n=e.params,i=dom.find(e.containerId);void 0===n&&(n={});let s=!1;for(let e=0;e<i.children.length;e++){let n=i.children[e];"DIV"==n.tagName&&"true"!=n.getAttribute("data-stack-back")&&(n.classList.remove("show"),n.classList.add("hide"),n.id==t&&(n.classList.remove("hide"),n.classList.add("show"),s=!0))}s||(e.empty=!1,ajax.view(e));let a=dom.find("div[data-stack-back]",i);null==a&&((a=dom.element('\n    <div data-stack-back="true" class="pointer">\n      <i class="fas fa-angle-left font-32" style="margin-top: 12px;"></i>\n    </div>\n  ')).style.position="fixed",a.style.width="60px",a.style.height="60px",a.style.bottom="40px",a.style.right="40px",a.style.backgroundColor="#0C9",a.style.color="#fff",a.style.borderRadius="50px",a.style.textAlign="center",a.style.boxShadow="2px 2px 3px #999",a.style.zIndex="99",dom.bind(a,"click",e=>{a.remove(),ajax.unstack({containerId:i})}),i.appendChild(a))},ajax.unstack=function(e){let t=dom.find(e.containerId);t.children[t.children.length-1].remove();let n=t.children[t.children.length-1];n.classList.remove("hide"),n.classList.add("show")},ajax.template=function(e){let t=e.url,n=e.usecase,i=e.containerId,s=e.templateId,a=e.data,o=e.success;xhr.post({url:t,usecase:n,data:a,success:function(e){if(i){var t=document.getElementById(s).innerHTML,n=Handlebars.compile(t)(e);document.getElementById(i).innerHTML=n}o&&o(e)}})},ajax.dialog=function(e){let t=e.title||"",n=e.url||"",i=e.params||{},s=e.success,a=e.end,o=!1!==e.shadeClose,l=!0===e.allowClose,r=e.width||"80%",d=e.height||"",c=e.offset||"auto";if(window.parameters)for(var u in i)window.parameters[u]=i[u];$.ajax({url:n,data:i,async:!0,success:function(e){layer.open({type:1,offset:c,title:t,closeBtn:!0===l?1:0,shade:.3,shadeClose:o,area:[r,d],content:e,success:function(e,t){document.querySelector(".layui-layer-content").style+="; overflow: hidden;",s&&s()},end:a||function(){}})}})},ajax.video=function(e,t,n,i){layer.open({type:2,title:!1,closeBtn:1,shade:[0],area:[n+"px",i+"px"],offset:"rb",anim:2,content:[e,"no"]})},ajax.svg=function(e,t,n,i){void 0===n&&(n={}),$.ajax({url:e,data:n,success:function(e){t.empty();var n=(new XMLSerializer).serializeToString(e.documentElement);t.html(n),i&&i(e)}})},ajax.upload=function(e){let t=e.data;void 0===t&&(t={});let n=new FormData;for(let e in t)n.append(e,t[e]);$.ajax({url:e.url,data:n,method:"POST",cache:!1,contentType:!1,processData:!1,xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&e.progress&&t.upload.addEventListener("progress",function(t){t.lengthComputable&&e.progress&&e.progress(t.total,t.loaded)},!1),t},success:function(t){e.success&&e.success(t)},error:function(t){e.error&&e.error(t)}})},ajax.sidebar=function(e){let t=dom.find(e.containerId),n=e.success||function(e,t){},i=dom.find("[widget-id=right-bar]"),s=e.allowClose||!1;null!=i&&i.remove(),i=dom.element('\n    <div widget-id="right-bar" style="position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: transparent; z-index: 999999;">\n      <div class="right-bar fade show">\n        <div class="modal-dialog" role="document">\n          <div class="modal-content">\n            <div class="card-header pl-3">\n              <h5 class="modal-title"></h5>\n              <button type="button" class="close text-danger">\n                <i class="fas fa-times"></i>\n              </button>\n            </div>\n            <div class="modal-body" style="overflow-y: auto;"></div>\n            <div style="position: absolute; bottom: 24px; left: 0; width: 100%; height: 48px; border-top: 1px solid lightgrey; background: white; display:none;">\n              <div widget-id="right-bar-bottom" class="mh-10 mt-2" style="float: right;"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  '),!0===e.showBottom&&(dom.find(".modal-body",i).style.marginBottom="36px",dom.find("[widget-id=right-bar-bottom]",i).parentElement.style.display=""),i.addEventListener("click",e=>{"right-bar"===e.target.getAttribute("widget-id")&&(i.children[0].classList.remove("in"),i.children[0].classList.add("out"),setTimeout(function(){i.remove()},300))}),t.appendChild(i),0==e.url.indexOf(":")&&(e.page=e.url.substring(1),e.url=null),e.url?xhr.get({url:e.url,success:function(t){dom.find(".modal-title",i).innerHTML=e.title||"",dom.find(".modal-body",i).innerHTML="",s||e.close||dom.find("button.close",i).classList.add("hidden"),dom.find("button.close",i).addEventListener("click",function(){i.children[0].classList.add("out"),i.remove(),e.close&&e.close()});let a=utils.append(dom.find(".modal-body",i),t);n&&n(e.title||"",a),setTimeout(function(){i.children[0].classList.remove("out"),i.children[0].classList.add("in")},300)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",params:{customWindowId:e.page},success:function(t){let a=t.data.script;dom.find(".modal-body",i).innerHTML="";let o=utils.append(dom.find(".modal-body",i),a);dom.find(".modal-title",i).innerHTML=e.title||"&nbsp;",s||e.close||dom.find("button.close",i).classList.add("hidden"),dom.find("button.close",i).addEventListener("click",function(){dom.find(".right-bar").classList.add("out"),setTimeout(function(){i.remove()},300),e.close&&e.close()}),n&&n(e.title||"",o),setTimeout(function(){i.children[0].classList.remove("out"),i.children[0].classList.add("in")},300)}})},ajax.bottombar=function(e){let t=dom.find(e.containerId),n=e.success||function(){},i=dom.find(".bottom-bar",t),s=e.allowClose||!1;null!=i&&i.remove(),i=dom.element('\n    <div class="bottom-bar fade show">\n      <div class="modal-dialog" role="document">\n        <div class="modal-content">\n          <div class="card-header pt-2 pb-2">\n            <button type="button" class="close text-danger">\n              <i class="fas fa-times"></i>\n            </button>\n            <h5 class="modal-title"></h5>\n          </div>\n          <div class="modal-body" style="overflow-y: auto"></div>\n        </div>\n      </div>\n    </div>\n  '),t.appendChild(i);let a=i.parentElement.clientWidth,o=parseInt(window.getComputedStyle(i.parentElement,null).getPropertyValue("padding-left")),l=parseInt(window.getComputedStyle(i.parentElement,null).getPropertyValue("padding-right"));i.style.width=a-l-o+"px",e.url?xhr.get({url:e.url,success:function(t){dom.find(".modal-title",i).innerHTML=e.title||"",s||e.close||dom.find("button.close",i).classList.add("hidden"),dom.find("button.close",i).addEventListener("click",function(){dom.find(".bottom-bar").classList.add("out"),e.close&&e.close()}),utils.append(dom.find(".modal-body",i),t),n&&n(t),setTimeout(function(){i.classList.remove("out"),i.classList.add("in")},200)}}):xhr.post({url:"/api/v3/common/script/stdbiz/uxd/custom_window/read",data:{customWindowId:e.page},success:function(t){let a=t.data.script;utils.append(dom.find(".modal-body",i),a),dom.find(".modal-title",i).innerHTML=e.title,s||e.close||dom.find("button.close",i).classList.add("hidden"),dom.find("button.close",i).addEventListener("click",function(){dom.find(".bottom-bar").classList.add("out"),e.close&&e.close()}),n&&n(t),setTimeout(function(){i.classList.remove("out"),i.classList.add("in")},200)}})},ajax.tabs=function(e){let t=document.querySelector(e.containerId),n=e.tabs,i=(e.closeable,dom.create("ul","nav","nav-tabs")),s=dom.create("div","tab-content"),a=dom.create("div","float-right"),o=dom.create("button","btn","btn-link");function l(e,t,n,i){ajax.view({url:t,containerId:e,success:function(){window[n]&&window[n].show(i)}})}a.appendChild(o),dom.bind(o,"click",function(){let e=dom.find("li.active link",this.parentElement.parentElement),t=e.getAttribute("data-model-url"),n=e.getAttribute("data-model-page"),i=JSON.parse("data-model-data");l(dom.find("div.tab-content div[data-model-url='"+t+"']",this.parentElement.parentElement),t,n,i)});for(let e=0;e<n.length;e++){let t=n[e],a=dom.create("li","nav-item"),o=dom.create("a","nav-link");0==e&&o.classList.add("active"),o.setAttribute("data-model-url",t.url),o.setAttribute("data-model-data",JSON.stringify(t.data||{})),o.setAttribute("data-model-page",t.page),o.innerHTML=t.title,dom.bind(o,"click",function(){if(this.classList.contains("active"))return;dom.find("a.active",this.parentElement.parentElement.parentElement).classList.remove("active"),dom.find("div.active",this.parentElement.parentElement.parentElement).classList.remove("active");let e=o.getAttribute("data-model-url"),t=JSON.parse(o.getAttribute("data-model-data")),n=o.getAttribute("data-model-page"),i=dom.find("div.tab-content div[data-model-url='"+e+"']",this.parentElement.parentElement.parentElement);this.classList.add("active"),i.classList.add("active"),""===i.innerHTML.trim()&&l(i,e,n,t)}),a.appendChild(o),i.appendChild(a);let r=dom.create("div","tab-pane");0==e&&(r.classList.add("active"),l(r,t.url,t.page,t.data)),r.setAttribute("data-model-url",t.url),s.append(r)}t.appendChild(a),t.appendChild(i),t.appendChild(s)},"undefined"==typeof dialog&&(dialog={}),dialog.alert=function(e){layer.open({type:0,icon:0,offset:"150px",shade:0,shadeClose:!0,title:"警告",content:e})},dialog.info=function(e){layer.open({type:0,offset:"150px",shade:0,shadeClose:!0,title:"信息",content:e})},dialog.info2=function(e){layer.open({type:0,offset:"100px",shade:.3,shadeClose:!0,title:"信息",content:e})},dialog.error=function(e){e=e.replaceAll("\n","<br>"),layer.open({type:0,icon:2,offset:"150px",shade:0,shadeClose:!0,title:"错误",content:e})},dialog.success=function(e,t){t?layer.open({type:0,icon:1,offset:"150px",shade:0,shadeClose:!0,title:"成功",content:e,btn:["确定","确定并返回"],yes:function(e,t){layer.close(e)},btn2:function(e,n){layer.close(e),t()}}):layer.open({type:0,icon:1,offset:"150px",shade:0,shadeClose:!0,title:"成功",content:e})},dialog.confirm=function(e,t){layer.confirm(e,{title:"确认",btn:["确定","取消"]},function(e){layer.close(e),t()},function(){})},dialog.view=function(e){let t=e.title,n=e.url;$(document.body);$("#dialogApplication").length&&$("#dialogApplication").remove();let i=[];e.save&&i.push({text:"保存",class:"btn-save",success:e.save}),$.ajax({url:n,success:function(e){let n=Handlebars.compile('<div class="modal fade" id="dialogApplication">  <div class="modal-dialog modal-dialog-centered">    <div class="modal-content">      <div class="modal-header">        <h4 class="modal-title">{{title}}</h4>        <button type="button" class="close" data-dismiss="modal">&times;</button>      </div>      <div id="dialogApplicationBody" class="modal-body">{{body}}</div>      <div class="modal-footer">        {{#each buttons}}        <button type="button" class="btn {{class}}" data-dismiss="modal">{{text}}</button>        {{/each}}        <button type="button" class="btn btn-close" data-dismiss="modal">关闭</button>      </div>    </div>  </div></div>')({title:t,body:e,buttons:i});$(document.body).append(n),$("#dialogApplication").modal("show")}})},dialog.select=function(e){ajax.view({url:e.url,success:function(t){layer.open({type:0,icon:1,offset:"150px",shade:.5,shadeClose:!0,title:e.title,content:t})}})},dialog.simplelist=async function(e){let t=await xhr.promise({url:e.url,params:e.params||{}}),n=dom.element('\n    <div>\n      <ul class="list-group"></ul>\n    </div>\n  '),i=dom.find("ul",n);for(let n=0;n<t.length;n++){let s=t[n],a=dom.create("li","list-group-item","list-group-item-action");dom.model(a,s),a.innerText=s[e.fields.text],i.appendChild(a)}layer.open({type:0,closeBtn:1,btn:[],shade:.5,shadeClose:!0,title:"",content:n.innerHTML,success:function(t,n){t.get(0).querySelectorAll("li").forEach((t,n)=>{dom.bind(t,"click",t=>{layer.close(layer.index);let n=dom.model(t.target);e.onAccept(n)})})}})},dialog.html=function(e){layer.open({type:0,closeBtn:1,offset:"150px",shade:.5,area:["50%",""],shadeClose:!0,title:e.title||"&nbsp;",content:e.html,btn:["确定","关闭"],success:function(t,n){e.load&&e.load(t,n)},yes:function(t){layer.close(t),e.success()},btn1:function(){}})},dialog.iframe=function(e){layer.open({title:e.title,type:2,area:[e.width,e.height],content:e.url,resize:!1,maxmin:!0,shade:!1,success:e.success||function(e,t){}})};var dom={value:function(e,t){const n=document.querySelector(e);if(!t)return n.value.trim();n.value=t},empty:function(e){const t=document.querySelector(e);t.value?t.value="":t.innerHTML=""},valid:function(e){const t=document.querySelector(e);return void 0!==t.value&&null!=t.value&&""!=t.value.trim()},create:function(e){let t=Array.prototype.slice.call(arguments,1),n=document.createElement(e);for(let e=0;e<t.length;e++)n.classList.add(t[e]);return n},fix:function(e){let t=null,n=(t="string"==typeof e?document.querySelector(e):e).getBoundingClientRect(),i=n.left,s=n.top,a=(n.width,n.height),o=(parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-left")),parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-right")),parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-top"))),l=parseInt(window.getComputedStyle(t,null).getPropertyValue("padding-bottom")),r=(parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-left")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-right")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-top")),parseInt(window.getComputedStyle(t,null).getPropertyValue("margin-bottom")),t.parentElement.parentElement),d=r.getBoundingClientRect(),c=parseInt(window.getComputedStyle(r,null).getPropertyValue("padding-left"));parseInt(window.getComputedStyle(r,null).getPropertyValue("padding-right")),parseInt(window.getComputedStyle(r,null).getPropertyValue("padding-top")),parseInt(window.getComputedStyle(r,null).getPropertyValue("padding-bottom"));return t.style.position="absolute",t.style.top=s-d.top+"px",t.style.left=i-d.left+"px",t.style.width="calc(100% - "+2*c+"px )",{top:s-d.top,left:i-d.left,width:d.width-2*c,height:a+o+l}},find:function(e,t){if(t=t||document,"string"!=typeof e)return e;let n=t.querySelectorAll(e);return 0==n.length?null:1==n.length?n[0]:n},ancestor:function(e,t,n){let i=null;if(n=n||"",null==(i="string"==typeof e?document.querySelector(e):e))return null;t=t.toUpperCase();let s=i;if(""==n)for(;null!=s&&s.tagName!=t;)s=s.parentElement;else for(;null!=s&&(s.tagName!=t||!s.classList.contains(n));)s=s.parentElement;return s},element:function(e){let t=document.createElement("div");return t.innerHTML=e,t.firstElementChild},bind:function(e,t,n){let i=null;null!=(i="string"==typeof e?document.querySelector(e):e)&&i&&i.addEventListener(t,n)},model:function(e,t){let n=null;if(n="string"==typeof e?document.querySelector(e):e,void 0===t){let e={};return Array.prototype.slice.call(n.attributes).forEach(function(t){if(0==t.name.indexOf("data-model-"))if(0==t.value.indexOf("{"))try{e[utils.nameVar(t.name.slice("data-model-".length))]=JSON.parse(t.value)}catch(n){e[utils.nameVar(t.name.slice("data-model-".length))]=t.value}else e[utils.nameVar(t.name.slice("data-model-".length))]=t.value}),e}{let e=Array.prototype.slice.call(arguments,2);if(0==e.length)for(const e in t)0!=e.indexOf("||")&&0!=e.indexOf("//")&&0!=e.indexOf(">>")&&("object"==typeof t[e]?n.setAttribute(utils.nameAttr(e),JSON.stringify(t[e])):n.setAttribute(utils.nameAttr(e),t[e]));else for(let i=0;i<e.length;i++){let s=e[i];0!=s.indexOf("||")&&0!=s.indexOf("//")&&0!=s.indexOf(">>")&&("object"==typeof t[s]?n.setAttribute(utils.nameAttr(s),JSON.stringify(t[s])):n.setAttribute(utils.nameAttr(s),t[s]))}}},collect:function(e,t){let n=[],i=document.querySelectorAll(e);for(let e=0;e<i.length;e++){let s={};if(Array.isArray(t))for(let n=0;n<t.length;n++)s[t[n]]=i[e].getAttribute(utils.nameAttr(t[n]));else s[t]=i.getAttribute(utils.nameAttr(t[j]));n.push(s)}return n},propagate:function(e,t,n,i){let s=i(t);if(Array.isArray(n))for(let e=0;e<n.length;e++)s.setAttribute(utils.nameAttr(n[e]),t[n[e]]);else s.setAttribute(utils.nameAttr(n),t[n]);e.appendChild(s)},toggle:function(e,t){let n=document.querySelectorAll(e);for(let e=0;e<n.length;e++){n[e].addEventListener("click",function(){let e=this.getAttribute("data-toggle").split(">>"),n=e[0].split("+"),i=e[1].split("+"),s=!1;for(let e=0;e<n.length;e++){let t=n[e].trim();if(0==t.indexOf("."))s=this.classList.contains(t.substring(1));else{s=null!=this.querySelector(t)}}if(s){for(let e=0;e<i.length;e++){let t=i[e].trim();if(0===t.indexOf("."))this.classList.add(t.substring(1));else{this.querySelector(t.substring(0,t.indexOf("."))).classList.add(t.substring(t.indexOf(".")+1))}}for(let e=0;e<n.length;e++){let t=n[e].trim();if(0==t.indexOf("."))this.classList.remove(t.substring(1));else{this.querySelector(t).classList.remove(t.substring(t.indexOf(".")+1))}}}else{for(let e=0;e<n.length;e++){let t=n[e].trim();if(0==t.indexOf("."))this.classList.add(t.substring(1));else{this.querySelector(t.substring(0,t.indexOf("."))).classList.add(t.substring(t.indexOf(".")+1))}}for(let e=0;e<i.length;e++){let t=i[e].trim();if(0==t.indexOf("."))this.classList.remove(t.substring(1));else{this.querySelector(t).classList.remove(t.substring(t.indexOf(".")+1))}}t&&resovle(this)}})}},switch:function(e,t){let n=dom.find(e),i=n.getAttribute("data-switch").split("+"),s=n.querySelectorAll(i[0]);for(let e=0;e<s.length;e++){let a=s[e];a.addEventListener("click",function(){let e=n.querySelectorAll(i[0]);for(let t=0;t<e.length;t++)e[t].classList.remove(i[1].substring(1));a.classList.add(i[1].substring(1)),t&&t(a)})}},tabs:function(e){let t=dom.find(e);if(null==t)return;let n=t.getAttribute("data-tab-active-class");for(let e=0;e<t.children.length;e++){let i=t.children[e];i.addEventListener("click",e=>{for(let e=0;e<t.children.length;e++){t.children[e].classList.remove(n)}i.classList.add(n)})}},top:function(e){let t=null;if(null==(t="string"==typeof e?document.querySelector(e):e))return 0;let n=t.offsetTop;return void 0!==t.offsetParent&&(n+=dom.top(t.offsetParent)),n},formdata:function(e,t){let n=null;if(n="string"==typeof e?document.querySelector(e):e,void 0===t){let e={},t={},i=n.querySelectorAll("input");for(let n=0;n<i.length;n++){let s=i[n],a=s.name,o=s.type,l=s.value;"text"==o||"number"==o||"password"==o||"hidden"==o?(e[a]=null,""!=l?-1!=a.indexOf("[]")?e[a]=[l]:e[a]=l:e[a]=""):"radio"==o?s.checked&&(e[a]=l):"checkbox"==o&&(void 0===t[a]&&(t[a]=0),s.checked&&(void 0===e[a]&&(t[a]=0,e[a]=[]),e[a].push(l)),t[a]+=1)}let s=n.querySelectorAll("select");for(let t=0;t<s.length;t++){let n=s[t],i=n.name;e[i]=null,-1!=n.selectedIndex?-1!=i.indexOf("[]")?e[i]=[n.value]:e[i]=n.value:e[i]=""}let a=n.querySelectorAll("textarea");for(let t=0;t<a.length;t++){let n=a[t],i=n.name;e[i]=null,e[i]=n.value}for(let n in t)-1==n.indexOf("[]")&&1==t[n]&&e[n]&&(e[n]=e[n][0]);for(let t in e)"string"==typeof e[t]&&0==e[t].indexOf("${")&&(e[t]=e[e[t].substring(2,e[t].length-1)]);return e}{function i(e,t,n){let i=dom.find("[name='"+t+"']",e);null!=i&&("INPUT"==i.tagName?"check"==i.type||(i.value=n||""):"SELECT"==i.tagName&&$("select[name='"+t+"']").val(n).trigger("change"))}for(let e in t)if("object"==typeof t[e])for(let s in t[e])i(n,e+"."+s,t[e][s]);else i(n,e,t[e])}},setAttribute:function(e,t,n){let i=document.querySelectorAll(e);for(let e=0;e<i.length;e++)i[e][t]=n},removeAttribute:function(e,t){let n=document.querySelectorAll(e);for(let e=0;e<n.length;e++)n[e].removeAttribute(t)},enable:function(e){let t=document.querySelectorAll(e);for(let e=0;e<t.length;e++)t[e].disabled=!1},disable:function(e){let t;t="string"==typeof e?document.querySelectorAll(e):e;for(let e=0;e<t.length;e++)t[e].disabled=!0},index:function(e,t,n){let i;if(i="string"==typeof e?dom.find(e):e,n);else{let e=i.getAttribute(t),n=i.parentElement.querySelectorAll(i.tagName);for(let i=0;i<n.length;i++){if(e==n[i].getAttribute(t))return i}}return-1},elementAt:function(e,t,n){let i=document.querySelectorAll(e);for(let e=0;e<i.length;e++){let s=i[e];if(n==s.getAttribute(t))return{index:e,element:s}}return null},elementAtTree:function(e,t,n,i,s){let a=document.querySelectorAll(e),o=0;for(let e=0;e<a.length;e++){let l=a[e],r=l.getAttribute(t);if(s==l.getAttribute(n)&&(o++,i==r))return{index:o,element:l}}},stack:function(e,t,n,i){let s=dom.create("a","btn","btn-link"),a=dom.create("i","fas","fa-caret-right","mr-1");s.appendChild(a),dom.bind(s,"click",function(){let a=dom.find("i",s);a.classList.contains("fa-caret-right")?(e.container.querySelectorAll("i.fa-caret-down").forEach(e=>{e.classList.remove("fa-caret-down"),e.classList.add("fa-caret-right")}),a.classList.remove("fa-caret-right"),a.classList.add("fa-caret-down"),e.stack(n,function(e){e.parentElement.classList.add("fade","fadeIn"),e.style.paddingLeft="50px",e.style.paddingRight="50px",setTimeout(function(){e.parentElement.classList.add("show")},200),i(e)})):(a.classList.remove("fa-caret-down"),a.classList.add("fa-caret-right"),t.parentElement.nextSibling.remove())})},inner:function(e){let t=e.clientHeight,n=e.clientWidth,i=getComputedStyle(e);return{height:t-parseInt(i.paddingTop)-parseInt(i.paddingBottom),width:n-parseInt(i.paddingLeft)-parseInt(i.paddingLeft)}},outer:function(e){let t=e.clientHeight,n=e.clientWidth,i=getComputedStyle(e);return{height:t+parseInt(i.marginTop)+parseInt(i.borderTop)+parseInt(i.marginBottom)+parseInt(i.borderBottom),width:n+parseInt(i.marginLeft)+parseInt(i.borderLeft)+parseInt(i.marginRight)+parseInt(i.borderRight)}},height:function(e,t,n){t=t||0,void 0===n&&(n=dom.find("#container")),n=n||document.body;let i=null;i="string"==typeof e?document.querySelector(e):e;let s=dom.top(i),a=getComputedStyle(n,null),o=(parseInt(a.getPropertyValue("padding-top")),parseInt(a.getPropertyValue("padding-bottom")));a=getComputedStyle(i,null);parseInt(a.getPropertyValue("border-top-width")),parseInt(a.getPropertyValue("border-bottom-width"));i.style.marginBottom="0px",i.style.height=n.clientHeight-s-t-o+"px",i.style.overflowY="auto"},templatize:function(e,t){let n=Handlebars.compile(e)(t);return dom.element(n)}};dom.render=function(e,t,n){let i=null;function s(e,t,i){let s=dom.find("[name='"+t+"']",e);null!=s&&("DIV"===s.nodeName&&n?i&&function(e,t){let n=dom.find("[value='"+t+"']",e);null!=n&&(n.checked=!0)}(s,i):"INPUT"==s.tagName?"radio"==s.type||(s.value=i):"SPAN"==s.tagName?i&&(s.innerHTML=i):"SELECT"==s.tagName&&$("select[name='"+t+"']").val(i).trigger("change"))}i="string"==typeof e?document.querySelector(e):e;for(let e in t)if("object"==typeof t[e])for(let n in t[e])s(i,e+"."+n,t[e][n]);else s(i,e,t[e])},dom.popup=function(e,t){let n=dom.create("div","full-width","full-height","position-absolute");return n.style.background="transparent",dom.bind(n,"click",e=>{n.remove(),t.remove()}),document.body.appendChild(n),e.appendChild(t),n},dom.html=function(e){let t=dom.element("<div></div>");return t.appendChild(e),t.innerHTML};let utils={};function Chat(e){this.host=e.host||"",this.userId=e.userId,this.userType=e.userType,this.getConversations=e.getConversations,this.onInit=e.onInit||async function(){},this.onSendTextMessage=e.onSendTextMessage,this.onSendImageMessage=e.onSendImageMessage,this.onSendAudioMessage=e.onSendAudioMessage,this.onSendVideoMessage=e.onSendVideoMessage,this.onSendCustomMessage=e.onSendCustomMessage,this.onRevokeMessage=e.onRevokeMessage||function(e){},this.onMessageReceived=e.onMessageReceived,this.onUnreadMessages=e.onUnreadMessages||function(e){},this.onReadMessages=e.onReadMessages||function(e){}}utils.append=function(e,t,n){let i=dom.create("div");i.style.height="100%",i.style.width="100%",n=n||!1;let s=document.createRange().createContextualFragment(t);n&&(e.innerHTML=""),e.appendChild(i),i.appendChild(s);let a=dom.find("[id^=page]",i);return a?i.setAttribute("page-id",a.id):i.setAttribute("page-id","page.not.in.database"),{id:a?a.id:"",container:i}},utils.message=function(e){if(!e&&0==e.length)return;let t="";for(let n=0;n<e.length;n++)t+=e[n].message+"<br>";return t},utils.prompt=function(e){if(e||0!=e.length)for(let t=0;t<e.length;t++)$(e[t].element).addClass("is-invalid")},utils.render=function(e,t,n){let i=document.getElementById(t).innerHTML,s=Handlebars.compile(i)(n);document.getElementById(e).innerHTML=s},utils.assemble=function(e,t){if("object"==typeof e)for(let n in e){let i=e[n];"object"==typeof i&&(e[n+"Id"]=i.id),"id"==n?e[t+"Id"]=i:"name"==n&&(e[t+"Name"]=i)}},utils.in=function(e){let t=e.split(" "),n=null,i=[];1==t.length?(n=document.getElementById(e),i.push(n)):i=(n=document.getElementById(t[0])).querySelectorAll(t[1]);for(let e=0;e<i.length;e++)(n=i[e]).addEventListener("animationend",function(){this.classList.remove("animated","fadeIn"),this.style.display="",this.removeEventListener("animationend",function(){}),this.removeEventListener("animationstart",function(){})}),n.classList.remove("fadeOut","hide"),n.classList.add("animated","fadeIn","show")},utils.out=function(e){let t=e.split(" "),n=null,i=[];1==t.length?(n=document.getElementById(e),i.push(n)):i=(n=document.getElementById(t[0])).querySelectorAll(t[1]);for(let e=0;e<i.length;e++)(n=i[e]).addEventListener("animationend",function(){this.classList.remove("animated","fadeOut"),this.removeEventListener("animationend",function(){})}),n.classList.remove("fadeIn","show"),n.classList.add("animated","fadeOut","hide")},utils.nameAttr=function(e){const t=[];let n="";for(let i=0;i<e.length;i++){let s=e.charAt(i);s==s.toUpperCase()?(t.push(n),n="",n+=s.toLowerCase()):n+=s}return""!=n&&t.push(n),"data-model-"+t.join("-")},utils.nameVar=function(e){if(-1==e.indexOf("-"))return e;const t=e.split("-");let n="";for(let e=0;e<t.length;e++){const i=t[e];n+=0==e?i:i.charAt(0).toUpperCase()+i.slice(1)}return n},utils.camelcase=function(e,t){if(-1==e.indexOf(t))return e;const n=e.split(t);let i="";for(let e=0;e<n.length;e++){const t=n[e];i+=0==e?t:t.charAt(0).toUpperCase()+t.slice(1)}return i},utils.pascalcase=function(e,t){if(-1==e.indexOf(t))return e.charAt(0).toUpperCase()+e.slice(1);const n=e.split(t);let i="";for(let e=0;e<n.length;e++){const t=n[e];i+=t.charAt(0).toUpperCase()+t.slice(1)}return i},utils.clone=function(e,t){e=e||{};for(let n in e)t[n]=e[n]},utils.get=function(e){let t=Array.prototype.slice.call(arguments,1),n={};for(let i=0;i<t.length;i++)n[t[i]]=e[t[i]];return n},utils.isEmpty=function(e){let t=0;for(let n in e)t++;return 0==t},utils.isBlank=function(e){let t=0;for(let n in e)null!=e[n]&&""!==e[n]&&t++;return 0==t},utils.getParameter=function(e,t){t=t.replace(/[\[\]]/g,"\\$&");let n=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},utils.getParameters=function(e){if(-1==e.indexOf("?"))return{};let t={},n=(e=e.substring(e.indexOf("?")+1)).split("&");for(let e=0;e<n.length;e++){let i=n[e].split("=");t[i[0].trim()]=decodeURIComponent(i[1].trim())}return t},utils.isExisting=((e,t,n)=>{for(let i=0;i<e.length;i++)if(e[i][n]===t[n])return!0;return!1}),Chat.MESSAGE_TYPE_TEXT="TEXT",Chat.MESSAGE_TYPE_IMAGE="IMAGE",Chat.MESSAGE_TYPE_AUDIO="AUDIO",Chat.MESSAGE_TYPE_VIDEO="VIDEO",Chat.MESSAGE_TYPE_PATIENT="PATIENT",Chat.MESSAGE_TYPE_CUSTOM="CUSTOM",Chat.MESSAGE_STATUS_UNREAD="01",Chat.MESSAGE_STATUS_READ="02",Chat.MESSAGE_STATUS_REVOKE="90",Chat.prototype.init=async function(e){await this.onInit();this.scheduleName=e;let t=this.userId+"@"+this.userType,n=await xhr.promise({url:this.host+"/api/v3/common/script/tim/user_signature",params:{userId:t}}),i={SDKAppID:n.appId};this.tim=TIM.create(i),this.tim.setLogLevel(1),this.tim.registerPlugin({"tim-upload-plugin":TIMUploadPlugin}),this.tim.login({userID:t,userSig:n.signature}),this.tim.on(TIM.EVENT.SDK_READY,function(e){}),this.tim.on(TIM.EVENT.MESSAGE_RECEIVED,e=>{for(let t=0;t<e.data.length;t++){let n=e.data[t],i=Chat.MESSAGE_TYPE_TEXT,s=null;"TIMCustomElem"===n.type?(s=JSON.parse(n.payload.data).messageContent).imagepath?i=Chat.MESSAGE_TYPE_IMAGE:s.audiopath?i=Chat.MESSAGE_TYPE_AUDIO:s.archiveId&&(i=Chat.MESSAGE_TYPE_PATIENT):s=n.payload.text,this.onMessageReceived({senderId:n.conversationID.substring(3),messageTime:moment(1e3*e.data[t].time).format("YYYY-MM-DD HH:mm"),messageType:i,messageContent:s})}})},Chat.prototype.getConversations=async function(){let e=await xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{status:Chat.MESSAGE_STATUS_UNREAD,receiverId:this.userId}}),t={};for(let n=0;n<e.length;n++){let i=e[n],s=i.senderId+"#"+i.senderType;if(t[s]){let e=t[s];e.createTime=i.createTime,e.messages.push(i)}else{let e={messages:[]};t[s]=e,e.id=s,e.createTime=i.createTime,e.name=i.senderType,e.senderId=i.senderId,e.senderType=i.senderType,e.messages.push(i)}}let n=[];for(let e in t)n.push(t[e]);return n},Chat.prototype.fetchMessages=async function(e,t,n){let i="";i=e>this.userId?e+"&"+this.userId:this.userId+"&"+e;let s=await xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{conversationId:i,_order_by:"messageTime asc"}}),a=[],o=null;for(let e=0;e<s.length;e++){let t=s[e],n=moment(t.createTime).format("YYYY-MM-DD HH:mm");n!=o&&(o=n,a.push({createTime:n,groupingMessages:[{direction:t.senderId==this.userId?"outgoing":"incoming",messages:[]}]}));let i=a[a.length-1],l=i.groupingMessages[i.groupingMessages.length-1],r="";r=t.senderId==this.userId?"outgoing":"incoming",l.direction===r?l.messages.push(t):i.groupingMessages.push({direction:r,messages:[t]})}return a},Chat.prototype.fetchUnreadMessages=function(){let e=this;xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/find",params:{status:Chat.MESSAGE_STATUS_UNREAD,receiverId:this.userId,receiverType:this.userType}}).then(t=>{e.onUnreadMessages(t)})},Chat.prototype.sendMessage=async function(e,t,n,i,s){return s=s||this.userId+"&"+e,"string"==typeof i&&(i=i.replace("\\","\\\\")),xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/save",params:{conversationId:s,senderId:this.userId,senderType:this.userType,receiverId:e,receiverType:t,messageType:n,messageTime:"now",messageContent:i,createTime:"now",status:Chat.MESSAGE_STATUS_UNREAD,"||stdbiz/pim/conversation/merge":{conversationId:s,conversationName:s,unreadCount:1,lastConversationTime:"now"}}})},Chat.prototype.sendTextMessage=async function(e,t,n,i){let s=e+"@"+t,a=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_TEXT,n,i),o=this.tim.createTextMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{id:a.conversationMessageId,text:n}});return this.tim.sendMessage(o)},Chat.prototype.sendImageMessage=async function(e,t,n,i){let s=e+"@"+t,a=await xhr.promise({url:this.host+"/api/v3/common/image",params:{directoryKey:"chat",filedata:n.data.substring(n.data.indexOf(",")+1),fileext:n.ext}}),o=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_IMAGE,JSON.stringify({imagepath:a.filepath,thumbnail:a.thumbnail}),i),l=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_IMAGE,messageContent:{id:o.conversationMessageId,imagepath:a.filepath,thumbnail:a.thumbnail}})}});return this.tim.sendMessage(l)},Chat.prototype.sendAudioMessage=async function(e,t,n,i){let s=e+"@"+t,a=await xhr.promise({url:this.host+"/api/v3/common/audio",params:{directoryKey:"chat",filedata:n.data.substring(n.data.indexOf(",")+1),fileext:"ogg"}}),o=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_AUDIO,JSON.stringify({audiopath:a.filepath,duration:a.duration}),i),l=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_AUDIO,messageContent:{id:o.conversationMessageId,audiopath:a.filepath,duration:a.duration}})}});return this.tim.sendMessage(l)},Chat.prototype.sendPatientMessage=async function(e,t,n,i){let s=e+"@"+t,a=await this.sendMessage(e,t,Chat.MESSAGE_TYPE_PATIENT,JSON.stringify(n),i);n.id=a.conversationMessageId;let o=this.tim.createCustomMessage({to:s,conversationType:TIM.TYPES.CONV_C2C,payload:{data:JSON.stringify({messageType:Chat.MESSAGE_TYPE_PATIENT,messageContent:n})}});return this.tim.sendMessage(o)},Chat.prototype.readMessages=function(e){let t=this;xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/update",params:{senderId:e,readTime:"now",status:Chat.MESSAGE_STATUS_READ}}).then(e=>{t.onReadMessages(e)})},Chat.prototype.revokeMessage=function(e){return xhr.promise({url:this.host+"/api/v3/common/script/stdbiz/pim/conversation_message/update",params:{messageId:e,status:Chat.MESSAGE_STATUS_REVOKE}}).then(t=>{this.onRevokeMessage(e)})},Chat.prototype.stop=function(){schedule.stop(this.scheduleName)},"undefined"!=typeof module&&(module.exports={Chat:Chat});